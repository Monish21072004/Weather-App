<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport">
    <title>Aether Station</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;family=Outfit:wght@300;400;500;700;800&amp;family=Space+Grotesk:wght@300;400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">

    <style>
        :root {
            --glass-surface: rgba(10, 14, 24, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shine: rgba(255, 255, 255, 0.03);
            --accent-cyan: #06b6d4;
            --accent-blue: #3b82f6;
            --text-main: #f8fafc;
            --card-radius: 24px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            color: var(--text-main);
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, .font-display { font-family: 'Space Grotesk', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* --- VISUAL ENGINE --- */
        #sky-gradient {
            position: fixed; inset: 0; z-index: -50;
            background: linear-gradient(to bottom, #0f172a, #020617);
            transition: background 2s ease;
        }

        #star-canvas {
            position: fixed; inset: 0; z-index: -45;
            opacity: 0; transition: opacity 2s; pointer-events: none;
        }

        /* Ambient Aurora */
        #aurora-layer {
            position: fixed; inset: 0; z-index: -40; pointer-events: none;
        }
        .aurora-blob {
            position: absolute; border-radius: 50%;
            filter: blur(100px); opacity: 0.3;
            animation: pulseBlob 20s infinite alternate ease-in-out;
            transition: background 2s;
        }
        @keyframes pulseBlob { 0% { transform: scale(1) translate(0,0); } 100% { transform: scale(1.2) translate(30px, -20px); } }

        /* Celestial Bodies */
        #celestial-container {
            position: fixed; top: 10%; right: 10%; width: 160px; height: 160px;
            z-index: -35; pointer-events: none;
            transition: all 2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .sun-orb {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fffbeb, #f59e0b);
            box-shadow: 0 0 100px rgba(251, 191, 36, 0.6);
            animation: sunGlow 5s infinite alternate;
        }
        @keyframes sunGlow { 0% { box-shadow: 0 0 80px rgba(251, 191, 36, 0.5); } 100% { box-shadow: 0 0 120px rgba(251, 191, 36, 0.8); } }
        
        .moon-svg { width: 100%; height: 100%; filter: drop-shadow(0 0 30px rgba(255,255,255,0.2)); }

        /* Atmospheric Layers */
        #cloud-layer-back { position: fixed; inset: 0; z-index: -30; opacity: 0; pointer-events: none; transition: opacity 2s; }
        #cloud-layer-front { position: fixed; inset: 0; z-index: -20; opacity: 0; pointer-events: none; transition: opacity 2s; }
        
        .cloud {
            position: absolute; border-radius: 50%;
            background: radial-gradient(closest-side, rgba(255,255,255,0.8), transparent);
            filter: blur(40px); animation: drift 120s linear infinite;
        }
        @keyframes drift { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }

        #mist-layer {
            position: fixed; inset: 0; z-index: -25; opacity: 0; pointer-events: none; transition: opacity 2s;
            background: linear-gradient(to top, rgba(200,215,225,0.2) 0%, transparent 50%);
        }

        #precip-canvas { position: fixed; inset: 0; z-index: -15; pointer-events: none; }
        
        #lightning {
            position: fixed; inset: 0; background: #fff; z-index: -5; opacity: 0; pointer-events: none; mix-blend-mode: overlay;
        }
        .flash-anim { animation: flash 0.3s ease-out; }
        @keyframes flash { 0%, 100% { opacity: 0; } 30% { opacity: 0.8; } }

        /* --- UI COMPONENTS --- */
        .glass {
            background: var(--glass-surface);
            backdrop-filter: blur(30px) saturate(140%);
            -webkit-backdrop-filter: blur(30px) saturate(140%);
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-shine);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            border-radius: var(--card-radius);
            transition: transform 0.3s ease, border-color 0.3s ease;
        }
        @media (hover: hover) {
            .glass:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.2); }
        }

        /* Tabs */
        .tab-btn {
            position: relative; cursor: pointer; opacity: 0.6; transition: opacity 0.3s;
        }
        .tab-btn.active { opacity: 1; }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 2px; background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
        }

        /* Search */
        .search-box { position: relative; z-index: 100; }
        #suggestions {
            position: absolute; top: 100%; left: 0; width: 100%; margin-top: 8px;
            background: rgba(10, 12, 20, 0.95); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; overflow: hidden; z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
        }

        /* Typography */
        .fluid-temp { font-size: clamp(4rem, 10vw, 7.5rem); }
        .fluid-h1 { font-size: clamp(2rem, 5vw, 4rem); }
        .text-glow { text-shadow: 0 0 30px rgba(255,255,255,0.2); }

        /* Loading */
        .loader {
            width: 48px; height: 48px; border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--accent-cyan); border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Custom Scroll */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="selection:bg-cyan-500/30">
    <!-- VISUAL ENGINE -->
    <div id="sky-gradient" style="background: linear-gradient(rgb(15, 23, 42), rgb(30, 41, 59));"></div>
    <canvas id="star-canvas" width="1468" height="541" style="opacity: 0;"></canvas>
    <div id="aurora-layer"><div class="aurora-blob bg-blue-900 w-[600px] h-[600px] top-[-20%] left-[-10%]"></div></div>
    <div id="celestial-container" style="filter: drop-shadow(rgba(255, 255, 255, 0.3) 0px 0px 30px); opacity: 0.2;">
        <svg viewBox="0 0 160 160" class="moon-svg">
            <defs><filter id="glow"><feGaussianBlur stdDeviation="2"></feGaussianBlur><feMerge><feMergeNode></feMergeNode><feMergeNode in="SourceGraphic"></feMergeNode></feMerge></filter></defs>
            <circle cx="80" cy="80" r="80" fill="#0f172a" opacity="0.6"></circle>
            <path d="M 80,0 A 80,80 0 0,1 80,160 A 39.491708818936004,80 0 0,0 80,0" fill="#f8fafc" filter="url(#glow)"></path>
        </svg>
    </div>
    <div id="cloud-layer-back" style="opacity: 0.6;"></div>
    <div id="mist-layer" style="opacity: 0;"></div>
    <div id="cloud-layer-front" style="opacity: 0.8;"></div>
    <canvas id="precip-canvas" width="1468" height="541"></canvas>
    <div id="lightning"></div>

    <!-- LOADER -->
    <div class="fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center transition-opacity duration-700 opacity-0 pointer-events-none" id="loader">
        <div class="loader mb-6"></div>
        <div class="font-mono text-cyan-400 text-xs tracking-[0.4em] animate-pulse">SYSTEM STARTUP</div>
    </div>

    <!-- MAIN APP -->
    <div class="relative w-full max-w-[1600px] mx-auto min-h-screen flex flex-col p-4 md:p-6 lg:p-8">
        <!-- HEADER -->
        <header class="flex flex-col lg:flex-row justify-between items-center gap-6 mb-8 relative z-50">
            <!-- Logo -->
            <div class="flex items-center gap-4 w-full lg:w-auto justify-start">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-700 flex items-center justify-center shadow-lg border border-white/10 shrink-0">
                    <span class="material-symbols-rounded text-white text-2xl">satellite_alt</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold font-display uppercase tracking-widest text-white">Aether</h1>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                        <span class="text-[10px] text-cyan-200 tracking-[0.2em] uppercase font-mono">Online</span>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col sm:flex-row w-full lg:w-auto gap-3 items-center">
                <!-- Search -->
                <div class="search-box w-full sm:w-80">
                    <div class="relative flex items-center bg-white/5 border border-white/10 rounded-full px-5 py-3 backdrop-blur-md focus-within:bg-black/60 focus-within:border-cyan-400/50 transition-all shadow-lg">
                        <span class="material-symbols-rounded text-gray-400">search</span>
                        <input autocomplete="off" enterkeyhint="search" class="w-full bg-transparent border-none outline-none text-white ml-3 text-sm font-medium placeholder-gray-500 h-full" id="search-input" placeholder="Search global sector..." type="text">
                        <!-- NEW: Clear Button -->
                        <button id="clear-btn" class="hidden text-gray-500 hover:text-white transition-colors">
                            <span class="material-symbols-rounded text-sm">close</span>
                        </button>
                    </div>
                    <div class="hidden" id="suggestions"></div>
                </div>
                <!-- Unit Toggle & GPS -->
                <div class="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-start">
                    <button class="h-12 px-5 rounded-full bg-white/5 border border-white/10 hover:bg-cyan-500/20 hover:border-cyan-400/50 hover:text-cyan-300 text-gray-300 transition-all flex items-center gap-2 shadow-lg" id="gps-btn">
                        <span class="material-symbols-rounded">my_location</span>
                        <span class="text-xs font-bold uppercase hidden sm:inline">Locate</span>
                    </button>
                    <div class="h-12 p-1 bg-black/40 border border-white/10 rounded-full flex relative shadow-inner shrink-0">
                        <div class="absolute left-1 top-1 bottom-1 w-[3rem] bg-gray-700 rounded-full transition-transform duration-300 z-0" id="unit-pill"></div>
                        <button class="relative z-10 w-[3rem] h-full rounded-full text-xs font-bold text-white transition-colors" id="btn-c">°C</button>
                        <button class="relative z-10 w-[3rem] h-full rounded-full text-xs font-bold text-gray-400 transition-colors" id="btn-f">°F</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ALERTS -->
        <div class="hidden w-full mb-6" id="alert-box">
            <div class="glass p-4 border-l-4 border-l-red-500 bg-red-900/20 flex items-center gap-4 relative overflow-hidden">
                <div class="absolute inset-0 bg-red-500/5 animate-pulse pointer-events-none"></div>
                <span class="material-symbols-rounded text-red-400 text-3xl z-10">warning</span>
                <div class="z-10">
                    <h3 class="text-red-400 font-bold uppercase text-[10px] tracking-widest mb-0.5">Severe Weather Alert</h3>
                    <p class="text-white text-sm font-medium leading-tight" id="alert-msg">Warning message text.</p>
                </div>
            </div>
        </div>

        <!-- DASHBOARD GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 transition-opacity duration-1000" id="dashboard">
            
            <!-- LEFT COLUMN (Main Info) -->
            <div class="lg:col-span-8 flex flex-col gap-6">
                <!-- 1. HERO CARD -->
                <div class="glass min-h-[450px] relative overflow-hidden group p-8 flex flex-col justify-between">
                    <!-- Background Icon -->
                    <div class="absolute right-[-5%] bottom-[-10%] opacity-[0.05] transform scale-150 group-hover:scale-125 transition-transform duration-1000 pointer-events-none">
                        <span class="material-symbols-rounded text-[25rem] text-white" id="bg-icon">cloud</span>
                    </div>
                    <div class="flex justify-between items-start z-10">
                        <div>
                            <div class="flex items-center gap-3 text-cyan-200/80 font-mono text-xs md:text-sm mb-3">
                                <span id="local-time">--:--</span>
                                <span class="w-1 h-1 bg-cyan-400 rounded-full"></span>
                                <span id="local-date">--</span>
                            </div>
                            <h2 class="fluid-h1 font-bold text-white leading-none tracking-tight text-glow" id="city-name">Loading...</h2>
                            <p class="text-xl text-cyan-100 mt-2 font-medium capitalize opacity-90" id="weather-desc">...</p>
                        </div>
                        <button class="w-12 h-12 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/40 hover:text-pink-500 transition-colors shadow-xl border border-white/5" id="fav-btn">
                            <span class="material-symbols-rounded">favorite</span>
                        </button>
                    </div>
                    <div class="flex items-end justify-between mt-auto z-10">
                        <div class="flex items-start">
                            <span class="fluid-temp font-bold text-white leading-[0.9] tracking-tighter text-glow" id="temp-val">--</span>
                            <span class="text-4xl lg:text-6xl text-cyan-400 mt-2 font-light">°</span>
                        </div>
                        <div class="text-right space-y-1">
                            <div class="flex items-center justify-end gap-2 text-sm font-medium text-gray-300">
                                <span>Feels Like</span>
                                <span class="text-white text-xl font-bold" id="feels-val">--°</span>
                            </div>
                            <div class="flex items-center justify-end gap-3 text-xs text-gray-400 mt-2">
                                <span class="flex items-center gap-1"><span class="material-symbols-rounded text-base text-red-300">arrow_upward</span><span class="text-white" id="temp-max">--°</span></span>
                                <span class="flex items-center gap-1"><span class="material-symbols-rounded text-base text-blue-300">arrow_downward</span><span class="text-white" id="temp-min">--°</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. TACTICAL ASSISTANT & METRICS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Assistant -->
                    <div class="glass flex flex-col h-full min-h-[300px]">
                        <div class="p-4 border-b border-white/5 bg-black/20 flex justify-between items-center rounded-t-[24px]">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-cyan-400">smart_toy</span>
                                <span class="text-xs font-bold uppercase tracking-widest text-cyan-100">Insight</span>
                            </div>
                            <!-- Tabs -->
                            <div class="flex gap-4 text-[10px] font-bold uppercase tracking-wider text-gray-500">
                                <div class="tab-btn active" data-tab="tab-overview">Brief</div>
                                <div class="tab-btn" data-tab="tab-health">Health</div>
                                <div class="tab-btn" data-tab="tab-activity">Activity</div>
                            </div>
                        </div>
                        <div class="p-6 flex-1 relative overflow-hidden">
                            <!-- Overview Tab -->
                            <div class="absolute inset-0 p-6 transition-opacity duration-300" id="tab-overview">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500/20 to-blue-500/10 border border-cyan-500/30 flex items-center justify-center shrink-0">
                                        <span class="material-symbols-rounded text-cyan-300 text-2xl" id="ai-icon">check_circle</span>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-white mb-1 text-base" id="ai-title">Analyzing...</h4>
                                        <p class="text-sm text-gray-300 leading-relaxed" id="ai-text">Please wait while we process atmospheric data.</p>
                                        <div class="flex flex-wrap gap-2 mt-3" id="ai-tags"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Health Tab -->
                            <div class="absolute inset-0 p-6 transition-opacity duration-300 opacity-0 pointer-events-none flex flex-col gap-3" id="tab-health">
                                <div>
                                    <div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-1">
                                        <span>UV Index</span><span class="text-white" id="uv-val">0.0</span>
                                    </div>
                                    <div class="h-2 w-full bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full w-0 bg-gradient-to-r from-green-400 to-red-500 transition-all duration-1000" id="uv-bar" style="width: 0%;"></div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5">
                                    <div class="text-xs font-bold text-gray-400 uppercase">Air Quality</div>
                                    <div class="text-xs font-bold px-2 py-1 rounded bg-green-500/20 text-green-400" id="aqi-badge">Good</div>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-white/5 rounded p-1"><div class="text-[9px] text-gray-500">PM2.5</div><div class="text-xs font-bold text-white" id="pm25-val">--</div></div>
                                    <div class="bg-white/5 rounded p-1"><div class="text-[9px] text-gray-500">NO2</div><div class="text-xs font-bold text-white" id="no2-val">--</div></div>
                                    <div class="bg-white/5 rounded p-1"><div class="text-[9px] text-gray-500">O3</div><div class="text-xs font-bold text-white" id="o3-val">--</div></div>
                                </div>
                            </div>
                            <!-- Activity Tab -->
                            <div class="absolute inset-0 p-6 transition-opacity duration-300 opacity-0 pointer-events-none grid grid-cols-2 gap-3" id="tab-activity">
                                <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex flex-col justify-center">
                                    <div class="flex items-center gap-2 mb-1 text-gray-400 text-xs font-bold uppercase"><span class="material-symbols-rounded text-sm">directions_run</span> Running</div>
                                    <div class="text-sm font-bold text-green-400" id="act-run">--</div>
                                </div>
                                <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex flex-col justify-center">
                                    <div class="flex items-center gap-2 mb-1 text-gray-400 text-xs font-bold uppercase"><span class="material-symbols-rounded text-sm">directions_car</span> Driving</div>
                                    <div class="text-sm font-bold text-white" id="act-drive">--</div>
                                </div>
                                <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex flex-col justify-center">
                                    <div class="flex items-center gap-2 mb-1 text-gray-400 text-xs font-bold uppercase"><span class="material-symbols-rounded text-sm">park</span> Outdoor</div>
                                    <div class="text-sm font-bold text-white" id="act-out">--</div>
                                </div>
                                <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex flex-col justify-center">
                                    <div class="flex items-center gap-2 mb-1 text-gray-400 text-xs font-bold uppercase"><span class="material-symbols-rounded text-sm">health_and_safety</span> Health</div>
                                    <div class="text-sm font-bold text-white" id="act-health">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metrics Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-2 gap-4">
                        <div class="glass p-4 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/5 transition-colors">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Wind</span>
                            <div class="flex items-center gap-1">
                                <span class="material-symbols-rounded text-cyan-400 text-2xl transform transition-transform" id="wind-icon" style="transform: rotate(0deg);">navigation</span>
                                <span class="text-xs font-bold text-white" id="wind-dir">--</span>
                            </div>
                            <div class="leading-none"><span class="text-lg font-bold text-white" id="wind-val">--</span> <span class="text-[10px] text-gray-400">km/h</span></div>
                            <div class="text-[9px] text-gray-500" id="wind-gusts">Gusts: --</div>
                        </div>
                        <div class="glass p-4 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/5 transition-colors">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Humidity</span>
                            <span class="material-symbols-rounded text-blue-400 text-2xl">water_drop</span>
                            <div class="leading-none"><span class="text-lg font-bold text-white" id="humid-val">--</span> <span class="text-[10px] text-gray-400">%</span></div>
                            <div class="text-[9px] text-gray-500">Dew: <span id="dew-val">--°</span></div>
                        </div>
                        <div class="glass p-4 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/5 transition-colors">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Pressure</span>
                            <span class="material-symbols-rounded text-purple-300 text-2xl">compress</span>
                            <div class="leading-none"><span class="text-lg font-bold text-white" id="pres-val">--</span> <span class="text-[10px] text-gray-400">hPa</span></div>
                        </div>
                        <div class="glass p-4 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/5 transition-colors">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Visibility</span>
                            <span class="material-symbols-rounded text-yellow-200 text-2xl">visibility</span>
                            <div class="leading-none"><span class="text-lg font-bold text-white" id="vis-val">--</span> <span class="text-[10px] text-gray-400">km</span></div>
                        </div>
                    </div>
                </div>

                <!-- 3. CHART -->
                <div class="glass p-6">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-symbols-rounded text-cyan-400 text-sm">show_chart</span>
                        <h3 class="text-xs font-bold text-white uppercase tracking-widest">24-Hour Forecast</h3>
                    </div>
                    <div class="h-64 w-full relative">
                        <canvas id="chart-canvas"></canvas>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN (Side) -->
            <div class="lg:col-span-4 flex flex-col gap-6">
                <!-- Moon & Sun Cycle -->
                <div class="glass p-6 flex flex-col gap-6">
                    <!-- Sun -->
                    <div class="flex items-center justify-between pb-4 border-b border-white/10">
                        <div class="text-center">
                            <span class="text-[9px] font-bold text-gray-500 uppercase mb-1 block">Sunrise</span>
                            <div class="flex items-center gap-2 text-orange-300"><span class="material-symbols-rounded text-lg">wb_twilight</span><span class="font-mono font-bold text-sm" id="sunrise-val">--:--</span></div>
                        </div>
                        <div class="h-8 w-px bg-white/10"></div>
                        <div class="text-center">
                            <span class="text-[9px] font-bold text-gray-500 uppercase mb-1 block">Sunset</span>
                            <div class="flex items-center gap-2 text-indigo-300"><span class="material-symbols-rounded text-lg">bedtime</span><span class="font-mono font-bold text-sm" id="sunset-val">--:--</span></div>
                        </div>
                    </div>
                    <!-- Moon Phase -->
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 shrink-0" id="moon-ui-container">
                            <!-- SVG injected via JS -->
                        </div>
                        <div>
                            <div class="text-[9px] font-bold text-gray-500 uppercase mb-1">Moon Phase</div>
                            <div class="text-sm font-bold text-white" id="moon-text">--</div>
                            <div class="text-xs text-gray-400" id="moon-pct">--% Lit</div>
                        </div>
                    </div>
                </div>

                <!-- 7-Day List -->
                <div class="glass flex-1 min-h-[400px] flex flex-col">
                    <div class="p-5 border-b border-white/5">
                        <h3 class="text-xs font-bold text-cyan-400 uppercase tracking-widest">7-Day Projection</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-1" id="forecast-list">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Radar -->
                <div class="glass h-56 relative overflow-hidden group rounded-2xl">
                    <div class="absolute top-3 left-3 z-10 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded text-[10px] font-bold text-cyan-400 border border-white/10 shadow-lg pointer-events-none">LIVE RADAR</div>
                    <iframe class="w-full h-full border-0 opacity-70 group-hover:opacity-100 transition-all duration-500 grayscale group-hover:grayscale-0" id="radar-frame" loading="lazy"></iframe>
                </div>
                
                <!-- Favorites -->
                <div class="flex flex-wrap gap-2 justify-center transition-opacity duration-1000 pb-6" id="fav-bar"></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const CONFIG = {
        weather: 'https://api.open-meteo.com/v1/forecast',
        geo: 'https://geocoding-api.open-meteo.com/v1/search',
        aqi: 'https://air-quality-api.open-meteo.com/v1/air-quality'
    };
    const STATE = {
        metric: true,
        data: null,
        chart: null,
        timer: null,
        animationId: null, // Track canvas loop
        favorites: JSON.parse(localStorage.getItem('aether_favs_v12')) || ['London', 'Tokyo', 'New York']
    };

    // --- UI ELEMENTS ---
    const el = id => document.getElementById(id);
    const ui = {
        // Loading & Search
        loader: el('loader'), dashboard: el('dashboard'), input: el('search-input'), suggestions: el('suggestions'), clearBtn: el('clear-btn'),
        gpsBtn: el('gps-btn'), btnC: el('btn-c'), btnF: el('btn-f'), unitPill: el('unit-pill'),
        // Main Data
        city: el('city-name'), desc: el('weather-desc'), temp: el('temp-val'), feels: el('feels-val'),
        tempMax: el('temp-max'), tempMin: el('temp-min'), time: el('local-time'), date: el('local-date'), bgIcon: el('bg-icon'),
        favBtn: el('fav-btn'), favBar: el('fav-bar'),
        // Metrics
        windVal: el('wind-val'), windIcon: el('wind-icon'), windDir: el('wind-dir'), windGusts: el('wind-gusts'),
        humidVal: el('humid-val'), dewVal: el('dew-val'), visVal: el('vis-val'), presVal: el('pres-val'),
        uvVal: el('uv-val'), uvBar: el('uv-bar'), aqiBadge: el('aqi-badge'),
        pm25: el('pm25-val'), no2: el('no2-val'), o3: el('o3-val'),
        // Assistant
        aiTitle: el('ai-title'), aiText: el('ai-text'), aiIcon: el('ai-icon'), aiTags: el('ai-tags'),
        actRun: el('act-run'), actDrive: el('act-drive'), actOut: el('act-out'), actHealth: el('act-health'),
        // Astro & Charts
        sunrise: el('sunrise-val'), sunset: el('sunset-val'),
        moonUI: el('moon-ui-container'), moonText: el('moon-text'), moonPct: el('moon-pct'),
        forecast: el('forecast-list'), chartCanvas: el('chart-canvas'), radar: el('radar-frame'),
        alert: el('alert-box'), alertMsg: el('alert-msg'),
        // Visuals
        sky: el('sky-gradient'), starCanvas: el('star-canvas'), aurora: el('aurora-layer'), celestial: el('celestial-container'),
        cloudsBack: el('cloud-layer-back'), cloudsFront: el('cloud-layer-front'), mist: el('mist-layer'),
        precipCanvas: el('precip-canvas'), lightning: el('lightning')
    };

    // --- MOON PHASE ENGINE ---
    function getMoonPhase(date) {
        const synodic = 29.53058867;
        const knownNewMoon = new Date('2000-01-06T18:14:00Z');
        const diff = (date - knownNewMoon) / (1000 * 60 * 60 * 24);
        let phase = (diff % synodic) / synodic;
        if(phase < 0) phase += 1;
        return phase; 
    }

    function createMoonSVG(phase, size=100, color="#e2e8f0") {
        const r = size/2, cx = size/2, cy = size/2;
        const isWaxing = phase <= 0.5;
        let progress = isWaxing ? phase/0.5 : (phase-0.5)/0.5; 
        let tr = Math.abs((progress - 0.5) * 2) * r;
        let outerDir = isWaxing ? 1 : 0;
        let innerDir = 0;
        if (isWaxing) innerDir = progress < 0.5 ? 0 : 1;
        else innerDir = progress < 0.5 ? 1 : 0;

        let d = "";
        if(phase > 0.48 && phase < 0.52) {
            d = `M ${cx},0 A ${r},${r} 0 1,1 ${cx},${size} A ${r},${r} 0 1,1 ${cx},0`; 
        } else if(phase < 0.02 || phase > 0.98) {
            d = ""; 
        } else {
            d = `M ${cx},0 A ${r},${r} 0 0,${outerDir} ${cx},${size} A ${tr},${r} 0 0,${innerDir} ${cx},0`;
        }

        return `
        <svg viewBox="0 0 ${size} ${size}" class="moon-svg">
            <defs><filter id="glow-${size}"><feGaussianBlur stdDeviation="2"/><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
            <circle cx="${cx}" cy="${cy}" r="${r}" fill="#0f172a" opacity="0.6"/>
            <path d="${d}" fill="${color}" filter="url(#glow-${size})"/>
        </svg>`;
    }

    function updateCelestial(isDay) {
        const container = ui.celestial;
        container.innerHTML = '';
        if(isDay) {
            const sun = document.createElement('div');
            sun.className = 'sun-orb';
            container.appendChild(sun);
            container.style.filter = 'none';
        } else {
            const phase = getMoonPhase(new Date());
            container.innerHTML = createMoonSVG(phase, 160, "#f8fafc");
            container.style.filter = 'drop-shadow(0 0 30px rgba(255,255,255,0.3))';
            updateMoonWidget(phase);
        }
    }

    function updateMoonWidget(phase) {
        ui.moonUI.innerHTML = createMoonSVG(phase, 48, "#ffffff");
        const pct = phase <= 0.5 ? phase*2 : (1-phase)*2;
        ui.moonPct.textContent = `${Math.round(pct*100)}% Lit`;
        let name = "New Moon";
        if(phase>0.02 && phase<0.23) name="Waxing Crescent";
        else if(phase>=0.23 && phase<0.27) name="First Quarter";
        else if(phase>=0.27 && phase<0.48) name="Waxing Gibbous";
        else if(phase>=0.48 && phase<0.52) name="Full Moon";
        else if(phase>=0.52 && phase<0.73) name="Waning Gibbous";
        else if(phase>=0.73 && phase<0.77) name="Last Quarter";
        else if(phase>=0.77 && phase<0.98) name="Waning Crescent";
        ui.moonText.textContent = name;
    }

    // --- VISUAL ENGINE (Canvas & CSS) ---
    const canvasS = ui.starCanvas.getContext('2d');
    const canvasP = ui.precipCanvas.getContext('2d');
    let w, h, stars=[], particles=[];

    function resize() { w=window.innerWidth; h=window.innerHeight; ui.starCanvas.width=ui.precipCanvas.width=w; ui.starCanvas.height=ui.precipCanvas.height=h; initStars(); }
    window.addEventListener('resize', resize);

    function initStars() {
        stars=[];
        for(let i=0; i<150; i++) stars.push({x:Math.random()*w, y:Math.random()*h, s:Math.random()*1.5, a:Math.random()});
    }

    function loop() {
        canvasS.clearRect(0,0,w,h); canvasP.clearRect(0,0,w,h);
        // Draw Stars
        if(ui.starCanvas.style.opacity === '1') {
            canvasS.fillStyle="#fff";
            stars.forEach(s=>{ 
                canvasS.globalAlpha=s.a; canvasS.beginPath(); canvasS.arc(s.x,s.y,s.s,0,Math.PI*2); canvasS.fill(); 
                if(Math.random()>0.99) s.a=Math.random();
            });
        }
        // Draw Precip
        particles.forEach(p => {
            p.y += p.vy; if(p.type==='snow') p.x+=Math.sin(p.y*0.01);
            if(p.y>h) { p.y=-10; p.x=Math.random()*w; }
            canvasP.beginPath();
            if(p.type==='rain') {
                canvasP.strokeStyle='rgba(200,230,255,0.4)'; canvasP.lineWidth=1; canvasP.moveTo(p.x,p.y); canvasP.lineTo(p.x,p.y+p.len); canvasP.stroke();
            } else {
                canvasP.fillStyle='rgba(255,255,255,0.8)'; canvasP.arc(p.x,p.y,p.s,0,Math.PI*2); canvasP.fill();
            }
        });
        STATE.animationId = requestAnimationFrame(loop);
    }
    
    // BATTERY SAVER: Pause animation when tab is hidden
    document.addEventListener("visibilitychange", () => {
        if (document.hidden) {
            if (STATE.animationId) cancelAnimationFrame(STATE.animationId);
        } else {
            loop();
        }
    });
    
    resize(); loop();

    // EXPANDED WEATHER CODES
    const weatherMeta = {
        0: { type: 'clear', day:['#0ea5e9','#93c5fd'], night:['#020617','#1e1b4b'] },
        1: { type: 'clear', day:['#38bdf8','#bae6fd'], night:['#0f172a','#172554'] },
        2: { type: 'cloudy', day:['#475569','#94a3b8'], night:['#1e293b','#334155'] },
        3: { type: 'overcast', day:['#334155','#64748b'], night:['#0f172a','#1e293b'] },
        45: { type: 'fog', day:['#6b7280','#9ca3af'], night:['#1f2937','#374151'] },
        48: { type: 'fog', day:['#6b7280','#9ca3af'], night:['#1f2937','#374151'] },
        51: { type: 'rain', day:['#2563eb','#60a5fa'], night:['#172554','#1e40af'] },
        53: { type: 'rain', day:['#2563eb','#60a5fa'], night:['#172554','#1e40af'] },
        55: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] },
        56: { type: 'rain', day:['#2563eb','#60a5fa'], night:['#172554','#1e40af'] },
        57: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] },
        61: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] },
        63: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] },
        65: { type: 'rain', day:['#1e40af','#60a5fa'], night:['#172554','#172554'] },
        66: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] },
        67: { type: 'rain', day:['#1e40af','#60a5fa'], night:['#172554','#172554'] },
        71: { type: 'snow', day:['#bae6fd','#e0f2fe'], night:['#1e293b','#334155'] },
        73: { type: 'snow', day:['#bae6fd','#e0f2fe'], night:['#1e293b','#334155'] },
        75: { type: 'snow', day:['#bae6fd','#e0f2fe'], night:['#1e293b','#334155'] },
        77: { type: 'snow', day:['#bae6fd','#e0f2fe'], night:['#1e293b','#334155'] },
        80: { type: 'rain', day:['#2563eb','#60a5fa'], night:['#172554','#1e40af'] },
        81: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] },
        82: { type: 'rain', day:['#1e40af','#60a5fa'], night:['#172554','#172554'] },
        85: { type: 'snow', day:['#bae6fd','#e0f2fe'], night:['#1e293b','#334155'] },
        86: { type: 'snow', day:['#bae6fd','#e0f2fe'], night:['#1e293b','#334155'] },
        95: { type: 'storm', day:['#4c1d95','#6d28d9'], night:['#2e1065','#581c87'] },
        96: { type: 'storm', day:['#4c1d95','#6d28d9'], night:['#2e1065','#581c87'] },
        99: { type: 'storm', day:['#4c1d95','#6d28d9'], night:['#2e1065','#581c87'] }
    };

    function setAtmosphere(code, isDay) {
        const meta = weatherMeta[code] || weatherMeta[0];
        const type = meta.type;
        const c = isDay ? meta.day : meta.night;
        
        // Gradient
        ui.sky.style.background = `linear-gradient(to bottom, ${c[0]}, ${c[1]})`;
        
        // Aurora (Colors)
        ui.aurora.innerHTML = '';
        let color = isDay ? (type==='storm'?'bg-purple-500':'bg-cyan-400') : (type==='storm'?'bg-purple-900':'bg-blue-900');
        ui.aurora.innerHTML = `<div class="aurora-blob ${color} w-[600px] h-[600px] top-[-20%] left-[-10%]"></div>`;

        // Celestial
        updateCelestial(isDay);
        ui.celestial.style.opacity = (type==='overcast'||type==='storm'||type==='fog') ? '0.2' : '1';
        
        // Layers Visibility
        ui.starCanvas.style.opacity = (!isDay && type==='clear') ? '1' : '0';
        ui.mist.style.opacity = type==='fog' ? '1' : '0';
        ui.cloudsBack.style.opacity = (type==='cloudy'||type==='overcast'||type==='storm') ? '0.6' : '0';
        ui.cloudsFront.style.opacity = (type==='overcast'||type==='storm') ? '0.8' : '0';

        // Generate Clouds
        ui.cloudsBack.innerHTML = ''; ui.cloudsFront.innerHTML = '';
        if(type.includes('cloud') || type==='overcast' || type==='storm') {
            const count = type==='cloudy'?5:12;
            for(let i=0; i<count; i++) {
                const cl = document.createElement('div');
                cl.className = 'cloud';
                const s = Math.random()*300+150;
                cl.style.width=s+'px'; cl.style.height=s+'px';
                cl.style.top=Math.random()*60+'%'; cl.style.left=Math.random()*100+'vw';
                cl.style.animationDuration = (Math.random()*60+60)+'s';
                if(i%2===0) ui.cloudsBack.appendChild(cl); else ui.cloudsFront.appendChild(cl);
            }
        }

        // Precip Particles
        particles = [];
        if(type==='rain'||type==='storm') for(let i=0;i<400;i++) particles.push({x:Math.random()*w,y:Math.random()*h,vy:Math.random()*15+15,len:20,type:'rain'});
        if(type==='snow') for(let i=0;i<200;i++) particles.push({x:Math.random()*w,y:Math.random()*h,vy:Math.random()*2+1,s:Math.random()*3+1,type:'snow'});

        // Lightning
        if(type==='storm') triggerLightning();
    }

    function triggerLightning() {
        const f = document.createElement('div');
        f.className = 'flash-anim';
        ui.lightning.appendChild(f);
        setTimeout(()=>f.remove(), 300);
        setTimeout(triggerLightning, Math.random()*5000+2000);
    }

    // --- DATA LOGIC ---
    async function fetchWeather(lat, lon, name) {
        ui.loader.classList.remove('opacity-0','pointer-events-none');
        try {
            const [w, a] = await Promise.all([
                fetch(`${CONFIG.weather}?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,surface_pressure,visibility,uv_index,dew_point_2m&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&timezone=auto&forecast_days=8`).then(r=>r.json()),
                fetch(`${CONFIG.aqi}?latitude=${lat}&longitude=${lon}&current=us_aqi,pm2_5,nitrogen_dioxide,ozone`).then(r=>r.json())
            ]);
            STATE.data = { ...w, aqi: a.current, cityName: name };
            renderUI();
            setTimeout(() => { ui.loader.classList.add('opacity-0','pointer-events-none'); ui.dashboard.classList.remove('opacity-0'); }, 500);
        } catch(e) { 
            console.error(e); 
            ui.loader.classList.add('opacity-0','pointer-events-none'); 
            // Minimal error handling feedback could go here
            ui.city.textContent = "Connection Error";
            ui.desc.textContent = "Try again later";
        }
    }

    function renderUI() {
        const d = STATE.data;
        const cur = d.current;
        const isDay = cur.is_day === 1;
        setAtmosphere(cur.weather_code, isDay);

        // Main
        ui.city.textContent = d.cityName;
        const meta = weatherMeta[cur.weather_code] || weatherMeta[0];
        ui.desc.textContent = meta.type.toUpperCase();
        ui.bgIcon.textContent = meta.type==='clear'?(isDay?'sunny':'clear_night'):meta.type==='cloudy'?'partly_cloudy_day':meta.type==='overcast'?'cloud':meta.type==='rain'?'rainy':meta.type==='snow'?'weather_snowy':'thunderstorm';

        // Temps
        let t=cur.temperature_2m, fl=cur.apparent_temperature, mx=d.daily.temperature_2m_max[0], mn=d.daily.temperature_2m_min[0];
        if(!STATE.metric) { const f=c=>c*1.8+32; t=f(t); fl=f(fl); mx=f(mx); mn=f(mn); }
        ui.temp.textContent = Math.round(t); ui.feels.textContent = Math.round(fl)+'°';
        ui.tempMax.textContent = Math.round(mx)+'°'; ui.tempMin.textContent = Math.round(mn)+'°';
        
        // Dynamic Title
        document.title = `${d.cityName} • ${Math.round(t)}° | Aether`;

        // Clock
        if(STATE.timer) clearInterval(STATE.timer);
        const tick = () => {
            const now = new Date();
            ui.time.textContent = now.toLocaleTimeString('en-US',{timeZone:d.timezone,hour:'2-digit',minute:'2-digit',hour12:false});
            ui.date.textContent = now.toLocaleDateString('en-US',{timeZone:d.timezone,weekday:'short',month:'short',day:'numeric'});
        }; tick(); STATE.timer = setInterval(tick,1000);

        // Assistant
        let tags = [], risk = 0;
        if(cur.weather_code>=95) { tags.push("STORM"); risk=2; }
        if(cur.precipitation>0) { tags.push("RAIN"); risk=1; }
        if(cur.uv_index>6) { tags.push("HIGH UV"); risk=1; }
        if(t < (STATE.metric?5:41)) { tags.push("FREEZING"); risk=1; }
        
        ui.aiTitle.textContent = risk===2?"Hazardous":risk===1?"Caution":"Optimal";
        ui.aiText.textContent = risk===2?"Severe weather conditions detected. Seek shelter." : risk===1?"Atmosphere unstable. Prepare accordingly." : "Conditions are stable. Enjoy your day.";
        ui.aiIcon.textContent = risk===2?"warning":risk===1?"info":"check_circle";
        ui.aiTags.innerHTML = tags.map(t=>`<span class="px-2 py-0.5 rounded bg-cyan-500/20 text-[10px] font-bold text-cyan-200 border border-cyan-500/30">${t}</span>`).join('');

        // Activities
        ui.actRun.textContent = (risk>0)?"Poor":"Great"; ui.actRun.className = `text-sm font-bold ${risk>0?'text-red-400':'text-green-400'}`;
        ui.actDrive.textContent = (cur.visibility<2000||cur.precipitation>0)?"Hazard":"Good"; 
        ui.actOut.textContent = (risk>0)?"Limit":"Enjoy";
        ui.actHealth.textContent = (d.aqi.us_aqi>100)?"Risk":"Good";

        // Metrics
        ui.windVal.textContent = Math.round(cur.wind_speed_10m);
        ui.windGusts.textContent = `Gusts: ${Math.round(cur.wind_gusts_10m)}`;
        ui.windIcon.style.transform = `rotate(${cur.wind_direction_10m}deg)`;
        const dirs = ['N','NE','E','SE','S','SW','W','NW'];
        ui.windDir.textContent = dirs[Math.round(cur.wind_direction_10m/45)%8] || 'N';
        
        ui.humidVal.textContent = cur.relative_humidity_2m;
        ui.visVal.textContent = (cur.visibility/1000).toFixed(1);
        ui.presVal.textContent = Math.round(cur.surface_pressure);
        ui.uvVal.textContent = cur.uv_index.toFixed(1);
        ui.uvBar.style.width = Math.min((cur.uv_index/11)*100,100)+'%';
        
        // AQI
        ui.aqiBadge.textContent = d.aqi.us_aqi<=50?'Good':d.aqi.us_aqi<=100?'Moderate':'Poor';
        ui.aqiBadge.className = `text-xs font-bold px-2 py-1 rounded bg-${d.aqi.us_aqi<=50?'green':d.aqi.us_aqi<=100?'yellow':'red'}-500/20 text-${d.aqi.us_aqi<=50?'green':d.aqi.us_aqi<=100?'yellow':'red'}-400`;
        ui.pm25.textContent = d.aqi.pm2_5; ui.no2.textContent = d.aqi.nitrogen_dioxide; ui.o3.textContent = d.aqi.ozone;

        // Solar
        const sr = new Date(d.daily.sunrise[0]), ss = new Date(d.daily.sunset[0]);
        ui.sunrise.textContent = sr.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false});
        ui.sunset.textContent = ss.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false});

        // Forecast List
        ui.forecast.innerHTML = '';
        for(let i=1; i<8; i++) {
            const code = d.daily.weather_code[i];
            const m = weatherMeta[code] || weatherMeta[0];
            let mx = d.daily.temperature_2m_max[i], mn = d.daily.temperature_2m_min[i];
            if(!STATE.metric) { mx=mx*1.8+32; mn=mn*1.8+32; }
            const day = new Date(d.daily.time[i]).toLocaleDateString('en-US',{weekday:'short'});
            const pop = d.daily.precipitation_probability_max[i];
            
            const row = document.createElement('div');
            row.className = "flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5";
            row.innerHTML = `<div class="w-12"><div class="font-bold text-gray-300 text-sm">${day}</div>${pop>20?`<div class="text-[9px] text-blue-400 font-bold">${pop}%</div>`:''}</div>
            <span class="material-symbols-rounded text-cyan-400 text-xl">${m.type==='clear'?'sunny':m.type==='rain'?'rainy':m.type==='cloudy'?'partly_cloudy_day':'cloud'}</span>
            <div class="text-sm font-mono font-bold text-right"><span class="text-white">${Math.round(mx)}°</span> <span class="text-gray-500">/ ${Math.round(mn)}°</span></div>`;
            ui.forecast.appendChild(row);
        }

        // Alert
        if(cur.weather_code>=95 || cur.wind_speed_10m > 60) {
            ui.alert.classList.remove('hidden');
            ui.alertMsg.textContent = cur.weather_code>=95 ? "Severe Thunderstorm Warning" : "High Wind Advisory";
        } else ui.alert.classList.add('hidden');

        // Chart & Radar
        renderChart(d.hourly);
        ui.radar.src = `https://embed.windy.com/embed.html?lat=${d.latitude}&lon=${d.longitude}&zoom=7&overlay=rain&menu=&metricWind=${STATE.metric?'kmh':'kt'}&metricTemp=${STATE.metric?'°C':'°F'}&isolines=false`;
        renderFavs();
    }

    function renderChart(hourly) {
        if(STATE.chart) STATE.chart.destroy();
        const ctx = ui.chartCanvas.getContext('2d');
        const now = new Date().getHours();
        const labels=[], data=[], rain=[];
        let sumTemp = 0;
        for(let i=0; i<24; i++) {
            labels.push(`${(now+i)%24}:00`);
            let t = hourly.temperature_2m[now+i];
            if(!STATE.metric) t=t*1.8+32;
            data.push(t);
            sumTemp += t;
            rain.push(hourly.precipitation_probability[now+i]);
        }
        
        // Determine Color Scheme based on avg temp
        const avg = sumTemp / 24;
        const isHot = STATE.metric ? avg > 25 : avg > 77;
        const color = isHot ? '#f97316' : '#22d3ee'; // Orange vs Cyan
        const bgStop = isHot ? 'rgba(249, 115, 22, 0.3)' : 'rgba(34, 211, 238, 0.3)';
        const bgStopEnd = isHot ? 'rgba(249, 115, 22, 0)' : 'rgba(34, 211, 238, 0)';

        STATE.chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    { 
                        label:'Temp', 
                        data, 
                        borderColor: color, 
                        backgroundColor:(c)=>{
                            const g=c.chart.ctx.createLinearGradient(0,0,0,200);
                            g.addColorStop(0, bgStop);
                            g.addColorStop(1, bgStopEnd);
                            return g;
                        }, 
                        borderWidth:2, 
                        tension:0.4, 
                        fill:true, 
                        yAxisID:'y'
                    },
                    { 
                        label:'Rain %', 
                        data:rain, 
                        borderColor:'#3b82f6', 
                        borderDash:[5,5], 
                        borderWidth:1, 
                        pointRadius:0, 
                        fill:false, 
                        yAxisID:'y1' 
                    }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false, 
                plugins:{ legend:{display:false} }, 
                scales:{ x:{display:false}, y:{display:false}, y1:{display:false, min:0, max:100} } 
            }
        });
    }

    // Interaction
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(t => {
        t.onclick = () => {
            tabs.forEach(b => b.classList.remove('active'));
            t.classList.add('active');
            ['tab-overview','tab-health','tab-activity'].forEach(id => {
                const p = el(id);
                if(id === t.dataset.tab) { p.style.opacity='1'; p.style.pointerEvents='auto'; }
                else { p.style.opacity='0'; p.style.pointerEvents='none'; }
            });
        };
    });

    let debounce;
    // Search Logic with Enter Key support and Clear Button
    ui.input.addEventListener('input', e => {
        const q = e.target.value;
        if(q.length > 0) ui.clearBtn.classList.remove('hidden'); 
        else ui.clearBtn.classList.add('hidden');

        clearTimeout(debounce);
        debounce = setTimeout(async () => {
            if(q.length<3) { ui.suggestions.classList.add('hidden'); return; }
            const r = await fetch(`${CONFIG.geo}?name=${q}&count=5`).then(res=>res.json());
            ui.suggestions.innerHTML = '';
            if(r.results) {
                r.results.forEach(p => {
                    const d = document.createElement('div');
                    d.className = "px-5 py-3 hover:bg-cyan-500/20 cursor-pointer text-sm text-white border-b border-white/5 flex justify-between";
                    d.innerHTML = `<span>${p.name}</span><span class="text-xs text-gray-500 font-bold uppercase">${p.country}</span>`;
                    d.onclick = () => { fetchWeather(p.latitude, p.longitude, p.name); ui.input.value=''; ui.clearBtn.classList.add('hidden'); ui.suggestions.classList.add('hidden'); };
                    ui.suggestions.appendChild(d);
                });
                ui.suggestions.classList.remove('hidden');
            }
        }, 300);
    });

    ui.input.addEventListener('keydown', e => {
        if(e.key === 'Enter' && ui.suggestions.children.length > 0) {
            ui.suggestions.children[0].click();
            ui.input.blur();
        }
    });

    ui.clearBtn.onclick = () => {
        ui.input.value = '';
        ui.clearBtn.classList.add('hidden');
        ui.suggestions.classList.add('hidden');
        ui.input.focus();
    };

    const setUnit = (m) => { STATE.metric=m; ui.unitPill.style.transform=m?'translateX(0)':'translateX(100%)'; ui.btnC.style.color=m?'#fff':'#6b7280'; ui.btnF.style.color=!m?'#fff':'#6b7280'; renderUI(); };
    ui.btnC.onclick = () => setUnit(true); ui.btnF.onclick = () => setUnit(false);
    ui.gpsBtn.onclick = () => navigator.geolocation.getCurrentPosition(p => fetchWeather(p.coords.latitude, p.coords.longitude, "My Location"));

    // Favorites
    function renderFavs() {
        ui.favBar.innerHTML = ''; ui.favBar.classList.remove('opacity-0');
        const isFav = STATE.favorites.includes(STATE.data.cityName);
        ui.favBtn.style.color = isFav ? '#ec4899' : 'rgba(255,255,255,0.4)';
        STATE.favorites.forEach(c => {
            const b = document.createElement('button');
            b.className = "px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-xs font-bold text-gray-300 hover:text-white hover:bg-cyan-500/20 transition-all shadow-lg";
            b.textContent = c;
            b.onclick = async () => { const r = await fetch(`${CONFIG.geo}?name=${c}&count=1`).then(res=>res.json()); if(r.results) fetchWeather(r.results[0].latitude, r.results[0].longitude, r.results[0].name); };
            ui.favBar.appendChild(b);
        });
    }
    ui.favBtn.onclick = () => {
        const n = STATE.data.cityName;
        if(STATE.favorites.includes(n)) STATE.favorites = STATE.favorites.filter(c=>c!==n); else STATE.favorites.push(n);
        localStorage.setItem('aether_favs_v12', JSON.stringify(STATE.favorites)); renderFavs();
    };

    // Init
    fetchWeather(51.5074, -0.1278, "London");
    document.addEventListener('click', e => { if(!el('search-input').contains(e.target) && !ui.clearBtn.contains(e.target)) ui.suggestions.classList.add('hidden'); });
});
</script>
</body>
</html>
