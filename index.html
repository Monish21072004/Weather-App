<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport">
    <title>Aether Station V3</title>
    <link rel="icon" type="image/png" href="https://fonts.gstatic.com/s/i/short-term/release/materialsymbolsrounded/sunny/default/24px.svg" id="dynamic-favicon">
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com" rel="preconnect">
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&amp;family=Outfit:wght@300;400;500;700;800&amp;family=Space+Grotesk:wght@300;400;500;600;700&amp;family=JetBrains+Mono:wght@400;500&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">

    <style>
        :root {
            --glass-surface: rgba(10, 14, 24, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-shine: rgba(255, 255, 255, 0.03);
            --accent-cyan: #06b6d4;
            --accent-blue: #3b82f6;
            --text-main: #f8fafc;
            --card-radius: 24px;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #000;
            color: var(--text-main);
            margin: 0;
            overflow-x: hidden;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        h1, h2, h3, .font-display { font-family: 'Space Grotesk', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* --- VISUAL ENGINE --- */
        #sky-gradient {
            position: fixed; inset: 0; z-index: -50;
            background: linear-gradient(to bottom, #0f172a, #020617);
            transition: background 2s ease;
        }

        #star-canvas {
            position: fixed; inset: 0; z-index: -45;
            opacity: 0; transition: opacity 2s; pointer-events: none;
        }

        /* Ambient Aurora */
        #aurora-layer {
            position: fixed; inset: 0; z-index: -40; pointer-events: none;
        }
        .aurora-blob {
            position: absolute; border-radius: 50%;
            filter: blur(100px); opacity: 0.3;
            animation: pulseBlob 20s infinite alternate ease-in-out;
            transition: background 2s;
        }
        @keyframes pulseBlob { 0% { transform: scale(1) translate(0,0); } 100% { transform: scale(1.2) translate(30px, -20px); } }

        /* Celestial Bodies */
        #celestial-container {
            position: fixed; top: 10%; right: 10%; width: 160px; height: 160px;
            z-index: -35; pointer-events: none;
            transition: all 2s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .sun-orb {
            width: 100%; height: 100%; border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #fffbeb, #f59e0b);
            box-shadow: 0 0 100px rgba(251, 191, 36, 0.6);
            animation: sunGlow 5s infinite alternate;
        }
        @keyframes sunGlow { 0% { box-shadow: 0 0 80px rgba(251, 191, 36, 0.5); } 100% { box-shadow: 0 0 120px rgba(251, 191, 36, 0.8); } }
        
        .moon-svg { width: 100%; height: 100%; filter: drop-shadow(0 0 30px rgba(255,255,255,0.2)); }

        /* Atmospheric Layers */
        #cloud-layer-back { position: fixed; inset: 0; z-index: -30; opacity: 0; pointer-events: none; transition: opacity 2s; }
        #cloud-layer-front { position: fixed; inset: 0; z-index: -20; opacity: 0; pointer-events: none; transition: opacity 2s; }
        
        .cloud {
            position: absolute; border-radius: 50%;
            background: radial-gradient(closest-side, rgba(255,255,255,0.8), transparent);
            filter: blur(40px); animation: drift 120s linear infinite;
        }
        @keyframes drift { from { transform: translateX(-100%); } to { transform: translateX(100vw); } }

        #mist-layer {
            position: fixed; inset: 0; z-index: -25; opacity: 0; pointer-events: none; transition: opacity 2s;
            background: linear-gradient(to top, rgba(200,215,225,0.2) 0%, transparent 50%);
        }

        #precip-canvas { position: fixed; inset: 0; z-index: -15; pointer-events: none; }
        
        #lightning {
            position: fixed; inset: 0; z-index: -5; pointer-events: none; mix-blend-mode: screen;
        }
        .flash-anim { 
            position: absolute; inset: 0;
            animation: flash 0.2s ease-out forwards; 
        }
        @keyframes flash { 0% { opacity: 0; } 50% { opacity: 0.6; } 100% { opacity: 0; } }

        /* --- UI COMPONENTS --- */
        .glass {
            background: var(--glass-surface);
            backdrop-filter: blur(30px) saturate(140%);
            -webkit-backdrop-filter: blur(30px) saturate(140%);
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-shine);
            box-shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
            border-radius: var(--card-radius);
            transition: transform 0.3s ease, border-color 0.3s ease;
            position: relative;
        }
        /* Noise Texture for Glass */
        .glass::before {
            content: ""; position: absolute; inset: 0; z-index: -1;
            opacity: 0.4; pointer-events: none; border-radius: inherit;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }

        @media (hover: hover) {
            .glass:hover { transform: translateY(-4px); border-color: rgba(255,255,255,0.2); }
        }

        /* Tabs */
        .tab-btn {
            position: relative; cursor: pointer; opacity: 0.6; transition: opacity 0.3s;
        }
        .tab-btn.active { opacity: 1; }
        .tab-btn.active::after {
            content: ''; position: absolute; bottom: -4px; left: 0; width: 100%; height: 2px; background: var(--accent-cyan);
            box-shadow: 0 0 10px var(--accent-cyan);
        }

        /* Search */
        .search-box { position: relative; z-index: 100; }
        #suggestions {
            position: absolute; top: 100%; left: 0; width: 100%; margin-top: 8px;
            background: rgba(10, 12, 20, 0.95); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; overflow: hidden; z-index: 100; box-shadow: 0 20px 50px rgba(0,0,0,0.7);
        }

        /* Typography */
        .fluid-temp { font-size: clamp(4rem, 10vw, 7.5rem); }
        .fluid-h1 { font-size: clamp(2rem, 5vw, 4rem); }
        .text-glow { text-shadow: 0 0 30px rgba(255,255,255,0.2); }

        /* Skeleton Loading */
        .skeleton {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            color: transparent !important;
            user-select: none;
            position: relative;
            overflow: hidden;
        }
        .skeleton::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            animation: skeletonShimmer 1.5s infinite;
        }
        @keyframes skeletonShimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
        
        /* Elements to hide when loaded */
        body.loaded .skeleton {
            animation: none; color: inherit !important; background: transparent;
        }
        body.loaded .skeleton::after { display: none; }
        
        body:not(.loaded) .data-content { opacity: 0; }
        body.loaded .data-content { opacity: 1; transition: opacity 0.5s; }

        /* Custom Scroll */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
    </style>
</head>
<body class="selection:bg-cyan-500/30">
    <!-- VISUAL ENGINE -->
    <div id="sky-gradient" style="background: linear-gradient(rgb(15, 23, 42), rgb(30, 41, 59));"></div>
    <canvas id="star-canvas" width="1468" height="541" style="opacity: 0;"></canvas>
    <div id="aurora-layer"><div class="aurora-blob bg-blue-900 w-[600px] h-[600px] top-[-20%] left-[-10%]"></div></div>
    <div id="celestial-container" style="filter: drop-shadow(rgba(255, 255, 255, 0.3) 0px 0px 30px); opacity: 0.2;">
        <svg viewBox="0 0 160 160" class="moon-svg">
            <defs><filter id="glow"><feGaussianBlur stdDeviation="2"></feGaussianBlur><feMerge><feMergeNode></feMergeNode><feMergeNode in="SourceGraphic"></feMergeNode></feMerge></filter></defs>
            <circle cx="80" cy="80" r="80" fill="#0f172a" opacity="0.6"></circle>
            <path d="M 80,0 A 80,80 0 0,1 80,160 A 39.491708818936004,80 0 0,0 80,0" fill="#f8fafc" filter="url(#glow)"></path>
        </svg>
    </div>
    <div id="cloud-layer-back" style="opacity: 0.6;"></div>
    <div id="mist-layer" style="opacity: 0;"></div>
    <div id="cloud-layer-front" style="opacity: 0.8;"></div>
    <canvas id="precip-canvas" width="1468" height="541"></canvas>
    <div id="lightning"></div>

    <!-- MAIN APP -->
    <div class="relative w-full max-w-[1600px] mx-auto min-h-screen flex flex-col p-4 md:p-6 lg:p-8">
        <!-- HEADER -->
        <header class="flex flex-col lg:flex-row justify-between items-center gap-6 mb-8 relative z-50">
            <!-- Logo -->
            <div class="flex items-center gap-4 w-full lg:w-auto justify-start">
                <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500 to-blue-700 flex items-center justify-center shadow-lg border border-white/10 shrink-0">
                    <span class="material-symbols-rounded text-white text-2xl">satellite_alt</span>
                </div>
                <div>
                    <h1 class="text-xl font-bold font-display uppercase tracking-widest text-white">Aether <span class="text-cyan-400 text-sm align-top opacity-50">v3</span></h1>
                    <div class="flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span>
                        <span class="text-[10px] text-cyan-200 tracking-[0.2em] uppercase font-mono">Online</span>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="flex flex-col sm:flex-row w-full lg:w-auto gap-3 items-center relative">
                <!-- Search -->
                <div class="search-box w-full sm:w-80">
                    <div class="relative flex items-center bg-white/5 border border-white/10 rounded-full px-5 py-3 backdrop-blur-md focus-within:bg-black/60 focus-within:border-cyan-400/50 transition-all shadow-lg">
                        <span class="material-symbols-rounded text-gray-400">search</span>
                        <input autocomplete="off" enterkeyhint="search" class="w-full bg-transparent border-none outline-none text-white ml-3 text-sm font-medium placeholder-gray-500 h-full" id="search-input" placeholder="Search global sector..." type="text">
                        <button id="clear-btn" class="hidden text-gray-500 hover:text-white transition-colors">
                            <span class="material-symbols-rounded text-sm">close</span>
                        </button>
                    </div>
                    <div class="hidden" id="suggestions"></div>
                </div>
                
                <!-- Unit Toggle & GPS -->
                <div class="flex items-center gap-2 w-full sm:w-auto justify-between sm:justify-start">
                    <button class="h-12 px-5 rounded-full bg-white/5 border border-white/10 hover:bg-cyan-500/20 hover:border-cyan-400/50 hover:text-cyan-300 text-gray-300 transition-all flex items-center gap-2 shadow-lg" id="gps-btn" aria-label="Locate Me">
                        <span class="material-symbols-rounded">my_location</span>
                        <span class="text-xs font-bold uppercase hidden sm:inline">Locate</span>
                    </button>
                    <button class="h-12 w-12 rounded-full bg-white/5 border border-white/10 hover:bg-cyan-500/20 hover:border-cyan-400/50 hover:text-cyan-300 text-gray-300 transition-all flex items-center justify-center shadow-lg" id="refresh-btn" aria-label="Refresh Data">
                        <span class="material-symbols-rounded">refresh</span>
                    </button>

                    <div class="h-12 p-1 bg-black/40 border border-white/10 rounded-full flex relative shadow-inner shrink-0">
                        <div class="absolute left-1 top-1 bottom-1 w-[3rem] bg-gray-700 rounded-full transition-transform duration-300 z-0" id="unit-pill"></div>
                        <button class="relative z-10 w-[3rem] h-full rounded-full text-xs font-bold text-white transition-colors" id="btn-c">°C</button>
                        <button class="relative z-10 w-[3rem] h-full rounded-full text-xs font-bold text-gray-400 transition-colors" id="btn-f">°F</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- ALERTS -->
        <div class="hidden w-full mb-6" id="alert-box">
            <div class="glass p-4 border-l-4 border-l-red-500 bg-red-900/20 flex items-center gap-4 relative overflow-hidden">
                <div class="absolute inset-0 bg-red-500/5 animate-pulse pointer-events-none"></div>
                <span class="material-symbols-rounded text-red-400 text-3xl z-10">warning</span>
                <div class="z-10">
                    <h3 class="text-red-400 font-bold uppercase text-[10px] tracking-widest mb-0.5">Severe Weather Alert</h3>
                    <p class="text-white text-sm font-medium leading-tight" id="alert-msg">Warning message text.</p>
                </div>
            </div>
        </div>

        <!-- DASHBOARD GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 transition-opacity duration-1000" id="dashboard">
            
            <!-- LEFT COLUMN (Main Info) -->
            <div class="lg:col-span-8 flex flex-col gap-6 min-w-0">
                <!-- 1. HERO CARD -->
                <div class="glass min-h-[450px] relative overflow-hidden group p-8 flex flex-col justify-between">
                    <!-- Background Icon -->
                    <div class="absolute right-[-5%] bottom-[-10%] opacity-[0.05] transform scale-150 group-hover:scale-125 transition-transform duration-1000 pointer-events-none">
                        <span class="material-symbols-rounded text-[25rem] text-white" id="bg-icon">cloud</span>
                    </div>
                    <div class="flex justify-between items-start z-10">
                        <div>
                            <div class="flex items-center gap-3 text-cyan-200/80 font-mono text-xs md:text-sm mb-3">
                                <span class="skeleton" id="local-time">--:--</span>
                                <span class="w-1 h-1 bg-cyan-400 rounded-full"></span>
                                <span class="skeleton" id="local-date">Loading Date</span>
                            </div>
                            <h2 class="fluid-h1 font-bold text-white leading-none tracking-tight text-glow skeleton" id="city-name" style="min-width: 200px; display: inline-block;">Loading...</h2>
                            <p class="text-xl text-cyan-100 mt-2 font-medium capitalize opacity-90 skeleton" id="weather-desc" style="max-width: 150px;">Processing...</p>
                        </div>
                        <button class="w-12 h-12 rounded-full bg-white/5 hover:bg-white/10 flex items-center justify-center text-white/40 hover:text-pink-500 transition-colors shadow-xl border border-white/5" id="fav-btn">
                            <span class="material-symbols-rounded">favorite</span>
                        </button>
                    </div>
                    <div class="flex items-end justify-between mt-auto z-10">
                        <div class="flex items-start">
                            <span class="fluid-temp font-bold text-white leading-[0.9] tracking-tighter text-glow skeleton" id="temp-val" style="min-width: 100px;">--</span>
                            <span class="text-4xl lg:text-6xl text-cyan-400 mt-2 font-light">°</span>
                        </div>
                        <div class="text-right space-y-1">
                            <div class="flex items-center justify-end gap-2 text-sm font-medium text-gray-300">
                                <span>Feels Like</span>
                                <span class="text-white text-xl font-bold skeleton" id="feels-val" style="min-width: 40px;">--°</span>
                            </div>
                            <div class="flex items-center justify-end gap-3 text-xs text-gray-400 mt-2">
                                <span class="flex items-center gap-1"><span class="material-symbols-rounded text-base text-red-300">arrow_upward</span><span class="text-white skeleton" id="temp-max">--°</span></span>
                                <span class="flex items-center gap-1"><span class="material-symbols-rounded text-base text-blue-300">arrow_downward</span><span class="text-white skeleton" id="temp-min">--°</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. TACTICAL ASSISTANT & METRICS -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Assistant -->
                    <div class="glass flex flex-col h-full min-h-[300px]">
                        <div class="p-4 border-b border-white/5 bg-black/20 flex justify-between items-center rounded-t-[24px]">
                            <div class="flex items-center gap-2">
                                <span class="material-symbols-rounded text-cyan-400">smart_toy</span>
                                <span class="text-xs font-bold uppercase tracking-widest text-cyan-100">Insight</span>
                            </div>
                            <!-- Tabs -->
                            <div class="flex gap-4 text-[10px] font-bold uppercase tracking-wider text-gray-500">
                                <div class="tab-btn active" data-tab="tab-overview">Brief</div>
                                <div class="tab-btn" data-tab="tab-health">Health</div>
                                <div class="tab-btn" data-tab="tab-activity">Activity</div>
                            </div>
                        </div>
                        <div class="p-6 flex-1 relative overflow-hidden">
                            <!-- Overview Tab -->
                            <div class="absolute inset-0 p-6 transition-opacity duration-300" id="tab-overview">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-cyan-500/20 to-blue-500/10 border border-cyan-500/30 flex items-center justify-center shrink-0">
                                        <span class="material-symbols-rounded text-cyan-300 text-2xl" id="ai-icon">check_circle</span>
                                    </div>
                                    <div>
                                        <h4 class="font-bold text-white mb-1 text-base skeleton" id="ai-title" style="min-width: 100px;">Analyzing...</h4>
                                        <p class="text-sm text-gray-300 leading-relaxed skeleton" id="ai-text" style="min-width: 200px;">Please wait while we process atmospheric data.</p>
                                        <!-- NEW: Gear Recommendation -->
                                        <div class="mt-3 flex items-center gap-2 text-xs font-mono text-cyan-200 bg-cyan-900/30 px-3 py-1.5 rounded-lg border border-cyan-500/20 skeleton" id="gear-text" style="display:inline-flex;">
                                            <span class="material-symbols-rounded text-sm">apparel</span>
                                            <span id="gear-msg">Calculating gear...</span>
                                        </div>
                                        <div class="flex flex-wrap gap-2 mt-3" id="ai-tags"></div>
                                    </div>
                                </div>
                            </div>
                            <!-- Health Tab -->
                            <div class="absolute inset-0 p-6 transition-opacity duration-300 opacity-0 pointer-events-none flex flex-col gap-3" id="tab-health">
                                <div>
                                    <div class="flex justify-between text-xs font-bold text-gray-400 uppercase mb-1">
                                        <span>UV Index</span><span class="text-white" id="uv-val">0.0</span>
                                    </div>
                                    <div class="h-2 w-full bg-gray-700 rounded-full overflow-hidden">
                                        <div class="h-full w-0 bg-gradient-to-r from-green-400 to-red-500 transition-all duration-1000" id="uv-bar" style="width: 0%;"></div>
                                    </div>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5">
                                    <div class="text-xs font-bold text-gray-400 uppercase">Air Quality</div>
                                    <div class="text-xs font-bold px-2 py-1 rounded bg-green-500/20 text-green-400" id="aqi-badge">Good</div>
                                </div>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-white/5 rounded p-1"><div class="text-[9px] text-gray-500">PM2.5</div><div class="text-xs font-bold text-white" id="pm25-val">--</div></div>
                                    <div class="bg-white/5 rounded p-1"><div class="text-[9px] text-gray-500">NO2</div><div class="text-xs font-bold text-white" id="no2-val">--</div></div>
                                    <div class="bg-white/5 rounded p-1"><div class="text-[9px] text-gray-500">O3</div><div class="text-xs font-bold text-white" id="o3-val">--</div></div>
                                </div>
                            </div>
                            <!-- Activity Tab -->
                            <div class="absolute inset-0 p-6 transition-opacity duration-300 opacity-0 pointer-events-none grid grid-cols-2 gap-3" id="tab-activity">
                                <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex flex-col justify-center">
                                    <div class="flex items-center gap-2 mb-1 text-gray-400 text-xs font-bold uppercase"><span class="material-symbols-rounded text-sm">directions_run</span> Running</div>
                                    <div class="text-sm font-bold text-green-400" id="act-run">--</div>
                                </div>
                                <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex flex-col justify-center">
                                    <div class="flex items-center gap-2 mb-1 text-gray-400 text-xs font-bold uppercase"><span class="material-symbols-rounded text-sm">directions_car</span> Driving</div>
                                    <div class="text-sm font-bold text-white" id="act-drive">--</div>
                                </div>
                                <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex flex-col justify-center">
                                    <div class="flex items-center gap-2 mb-1 text-gray-400 text-xs font-bold uppercase"><span class="material-symbols-rounded text-sm">park</span> Outdoor</div>
                                    <div class="text-sm font-bold text-white" id="act-out">--</div>
                                </div>
                                <div class="bg-white/5 rounded-xl p-3 border border-white/5 flex flex-col justify-center">
                                    <div class="flex items-center gap-2 mb-1 text-gray-400 text-xs font-bold uppercase"><span class="material-symbols-rounded text-sm">health_and_safety</span> Health</div>
                                    <div class="text-sm font-bold text-white" id="act-health">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Metrics Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-2 gap-4">
                        <div class="glass p-4 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/5 transition-colors">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Wind</span>
                            <div class="flex items-center gap-1">
                                <span class="material-symbols-rounded text-cyan-400 text-2xl transform transition-transform" id="wind-icon" style="transform: rotate(0deg);">navigation</span>
                                <span class="text-xs font-bold text-white skeleton" id="wind-dir" style="min-width: 20px;">--</span>
                            </div>
                            <div class="leading-none"><span class="text-lg font-bold text-white skeleton" id="wind-val" style="min-width: 30px;">--</span> <span class="text-[10px] text-gray-400">km/h</span></div>
                            <div class="text-[9px] text-gray-500" id="wind-gusts">Gusts: --</div>
                        </div>
                        <div class="glass p-4 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/5 transition-colors">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Humidity</span>
                            <span class="material-symbols-rounded text-blue-400 text-2xl">water_drop</span>
                            <div class="leading-none"><span class="text-lg font-bold text-white skeleton" id="humid-val" style="min-width: 30px;">--</span> <span class="text-[10px] text-gray-400">%</span></div>
                            <div class="text-[9px] text-gray-500">Dew: <span id="dew-val">--°</span></div>
                        </div>
                        <div class="glass p-4 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/5 transition-colors">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Pressure</span>
                            <span class="material-symbols-rounded text-purple-300 text-2xl">compress</span>
                            <div class="leading-none"><span class="text-lg font-bold text-white skeleton" id="pres-val" style="min-width: 40px;">--</span> <span class="text-[10px] text-gray-400">hPa</span></div>
                        </div>
                        <div class="glass p-4 flex flex-col items-center justify-center text-center gap-2 hover:bg-white/5 transition-colors">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Visibility</span>
                            <span class="material-symbols-rounded text-yellow-200 text-2xl">visibility</span>
                            <div class="leading-none"><span class="text-lg font-bold text-white skeleton" id="vis-val" style="min-width: 30px;">--</span> <span class="text-[10px] text-gray-400">km</span></div>
                        </div>
                    </div>
                </div>

                <!-- 3. CHART -->
                <!-- FIX: Added min-w-0 to parent and container to ensure Chart.js resizes down properly -->
                <div class="glass p-6 w-full min-w-0">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-symbols-rounded text-cyan-400 text-sm">show_chart</span>
                        <h3 class="text-xs font-bold text-white uppercase tracking-widest">24-Hour Forecast</h3>
                    </div>
                    <!-- Responsive height: shorter on mobile (h-48), standard on desktop (h-64) -->
                    <div class="h-48 md:h-64 w-full relative">
                        <canvas id="chart-canvas" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN (Side) -->
            <div class="lg:col-span-4 flex flex-col gap-6">
                <!-- Moon & Sun Cycle (UPDATED) -->
                <div class="glass p-6 flex flex-col gap-6 relative overflow-hidden">
                    <!-- Solar Arc Visualizer -->
                    <div class="relative w-full h-32 flex flex-col items-center justify-end">
                        <div class="absolute inset-0 flex items-center justify-center text-[10px] text-gray-500 font-mono tracking-widest uppercase mb-6">Solar Tracker</div>
                        
                        <!-- The Arc -->
                        <div class="relative w-full h-full">
                            <svg viewBox="0 0 200 100" class="w-full h-full overflow-visible">
                                <!-- Track -->
                                <path d="M 10 90 A 90 90 0 0 1 190 90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="2" stroke-dasharray="4,4" />
                                <!-- Sun/Moon Marker -->
                                <g id="solar-marker" style="transition: transform 1s cubic-bezier(0.4, 0, 0.2, 1);">
                                    <!-- Sun Glow -->
                                    <circle cx="0" cy="0" r="8" fill="#fbbf24" class="opacity-0 transition-opacity duration-500" id="marker-sun" style="filter: drop-shadow(0 0 10px #fbbf24);"></circle>
                                    <!-- Moon Glow -->
                                    <circle cx="0" cy="0" r="6" fill="#e2e8f0" class="opacity-0 transition-opacity duration-500" id="marker-moon" style="filter: drop-shadow(0 0 8px rgba(255,255,255,0.8));"></circle>
                                </g>
                            </svg>
                        </div>

                        <!-- Times -->
                        <div class="absolute bottom-0 w-full flex justify-between text-xs font-bold text-gray-400 px-2">
                            <span id="sunrise-val">--:--</span>
                            <span id="sunset-val">--:--</span>
                        </div>
                    </div>

                    <!-- Moon Phase -->
                    <div class="flex items-center gap-4 pt-4 border-t border-white/10">
                        <div class="w-10 h-10 shrink-0" id="moon-ui-container"></div>
                        <div>
                            <div class="text-[9px] font-bold text-gray-500 uppercase mb-0.5">Moon Phase</div>
                            <div class="text-xs font-bold text-white" id="moon-text">--</div>
                        </div>
                    </div>
                </div>

                <!-- 7-Day List -->
                <div class="glass flex-1 min-h-[400px] flex flex-col">
                    <div class="p-5 border-b border-white/5">
                        <h3 class="text-xs font-bold text-cyan-400 uppercase tracking-widest">7-Day Projection</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-1" id="forecast-list">
                        <!-- Injected via JS -->
                    </div>
                </div>

                <!-- Radar -->
                <div class="glass h-56 relative overflow-hidden group rounded-2xl">
                    <div class="absolute top-3 left-3 z-10 bg-black/60 backdrop-blur-md px-2 py-0.5 rounded text-[10px] font-bold text-cyan-400 border border-white/10 shadow-lg pointer-events-none">LIVE RADAR</div>
                    <iframe class="w-full h-full border-0 opacity-70 group-hover:opacity-100 transition-all duration-500 grayscale group-hover:grayscale-0" id="radar-frame" loading="lazy"></iframe>
                </div>
                
                <!-- Favorites -->
                <div class="flex flex-wrap gap-2 justify-center transition-opacity duration-1000 pb-6" id="fav-bar"></div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const CONFIG = {
        weather: 'https://api.open-meteo.com/v1/forecast',
        geo: 'https://geocoding-api.open-meteo.com/v1/search',
        aqi: 'https://air-quality-api.open-meteo.com/v1/air-quality'
    };
    
    // Initialize State with persistent Metric preference
    const STATE = {
        metric: localStorage.getItem('aether_units') !== 'false', // Default to true if null
        data: null,
        chart: null,
        timer: null,
        lightningTimer: null,
        animationId: null,
        lightningBolts: [],
        favorites: JSON.parse(localStorage.getItem('aether_favs_v12')) || ['London', 'Tokyo', 'New York']
    };
    
    // Fallback Cities for Random Selection
    const RANDOM_CITIES = [
        {name: "London", lat: 51.5074, lon: -0.1278},
        {name: "Tokyo", lat: 35.6762, lon: 139.6503},
        {name: "New York", lat: 40.7128, lon: -74.0060},
        {name: "Paris", lat: 48.8566, lon: 2.3522},
        {name: "Singapore", lat: 1.3521, lon: 103.8198},
        {name: "Sydney", lat: -33.8688, lon: 151.2093},
        {name: "Dubai", lat: 25.2048, lon: 55.2708},
        {name: "Reykjavik", lat: 64.1466, lon: -21.9426}
    ];

    // --- UI ELEMENTS ---
    const el = id => document.getElementById(id);
    const ui = {
        // Loading & Search
        dashboard: el('dashboard'), input: el('search-input'), suggestions: el('suggestions'), clearBtn: el('clear-btn'),
        gpsBtn: el('gps-btn'), refreshBtn: el('refresh-btn'), btnC: el('btn-c'), btnF: el('btn-f'), unitPill: el('unit-pill'),
        favicon: el('dynamic-favicon'),
        // Main Data
        city: el('city-name'), desc: el('weather-desc'), temp: el('temp-val'), feels: el('feels-val'),
        tempMax: el('temp-max'), tempMin: el('temp-min'), time: el('local-time'), date: el('local-date'), bgIcon: el('bg-icon'),
        favBtn: el('fav-btn'), favBar: el('fav-bar'),
        // Metrics
        windVal: el('wind-val'), windIcon: el('wind-icon'), windDir: el('wind-dir'), windGusts: el('wind-gusts'),
        humidVal: el('humid-val'), dewVal: el('dew-val'), visVal: el('vis-val'), presVal: el('pres-val'),
        uvVal: el('uv-val'), uvBar: el('uv-bar'), aqiBadge: el('aqi-badge'),
        pm25: el('pm25-val'), no2: el('no2-val'), o3: el('o3-val'),
        // Assistant
        aiTitle: el('ai-title'), aiText: el('ai-text'), aiIcon: el('ai-icon'), aiTags: el('ai-tags'),
        gearText: el('gear-text'), gearMsg: el('gear-msg'),
        actRun: el('act-run'), actDrive: el('act-drive'), actOut: el('act-out'), actHealth: el('act-health'),
        // Astro & Charts
        sunrise: el('sunrise-val'), sunset: el('sunset-val'), solarMarker: el('solar-marker'), markerSun: el('marker-sun'), markerMoon: el('marker-moon'),
        moonUI: el('moon-ui-container'), moonText: el('moon-text'),
        forecast: el('forecast-list'), chartCanvas: el('chart-canvas'), radar: el('radar-frame'),
        alert: el('alert-box'), alertMsg: el('alert-msg'),
        // Visuals
        sky: el('sky-gradient'), starCanvas: el('star-canvas'), aurora: el('aurora-layer'), celestial: el('celestial-container'),
        cloudsBack: el('cloud-layer-back'), cloudsFront: el('cloud-layer-front'), mist: el('mist-layer'),
        precipCanvas: el('precip-canvas'), lightning: el('lightning')
    };

    // Initialize UI based on persistent state
    if(!STATE.metric) { ui.unitPill.style.transform='translateX(100%)'; ui.btnC.style.color='#6b7280'; ui.btnF.style.color='#fff'; }

    // --- MOON PHASE ENGINE ---
    function getMoonPhase(date) {
        const synodic = 29.53058867;
        const knownNewMoon = new Date('2000-01-06T18:14:00Z');
        const diff = (date - knownNewMoon) / (1000 * 60 * 60 * 24);
        let phase = (diff % synodic) / synodic;
        if(phase < 0) phase += 1;
        return phase; 
    }

    function createMoonSVG(phase, size=100, color="#e2e8f0") {
        const r = size/2, cx = size/2, cy = size/2;
        const isWaxing = phase <= 0.5;
        let progress = isWaxing ? phase/0.5 : (phase-0.5)/0.5; 
        let tr = Math.abs((progress - 0.5) * 2) * r;
        let outerDir = isWaxing ? 1 : 0;
        let innerDir = 0;
        if (isWaxing) innerDir = progress < 0.5 ? 0 : 1;
        else innerDir = progress < 0.5 ? 1 : 0;

        let d = "";
        if(phase > 0.48 && phase < 0.52) {
            d = `M ${cx},0 A ${r},${r} 0 1,1 ${cx},${size} A ${r},${r} 0 1,1 ${cx},0`; 
        } else if(phase < 0.02 || phase > 0.98) { d = ""; } 
        else { d = `M ${cx},0 A ${r},${r} 0 0,${outerDir} ${cx},${size} A ${tr},${r} 0 0,${innerDir} ${cx},0`; }

        return `
        <svg viewBox="0 0 ${size} ${size}" class="moon-svg">
            <defs><filter id="glow-${size}"><feGaussianBlur stdDeviation="2"/><feMerge><feMergeNode/><feMergeNode in="SourceGraphic"/></feMerge></filter></defs>
            <circle cx="${cx}" cy="${cy}" r="${r}" fill="#0f172a" opacity="0.6"/>
            <path d="${d}" fill="${color}" filter="url(#glow-${size})"/>
        </svg>`;
    }

    function updateCelestial(isDay) {
        const container = ui.celestial;
        container.innerHTML = '';
        if(isDay) {
            const sun = document.createElement('div');
            sun.className = 'sun-orb';
            container.appendChild(sun);
            container.style.filter = 'none';
        } else {
            const phase = getMoonPhase(new Date());
            container.innerHTML = createMoonSVG(phase, 160, "#f8fafc");
            container.style.filter = 'drop-shadow(0 0 30px rgba(255,255,255,0.3))';
        }
    }

    function updateMoonWidget(phase) {
        ui.moonUI.innerHTML = createMoonSVG(phase, 40, "#ffffff");
        let name = "New Moon";
        if(phase>0.035 && phase<0.215) name="Waxing Crescent";
        else if(phase>=0.215 && phase<0.285) name="First Quarter";
        else if(phase>=0.285 && phase<0.465) name="Waxing Gibbous";
        else if(phase>=0.465 && phase<0.535) name="Full Moon";
        else if(phase>=0.535 && phase<0.715) name="Waning Gibbous";
        else if(phase>=0.715 && phase<0.785) name="Third Quarter"; 
        else if(phase>=0.785 && phase<0.965) name="Waning Crescent";
        ui.moonText.textContent = name;
    }

    // --- VISUAL ENGINE ---
    const canvasS = ui.starCanvas.getContext('2d');
    const canvasP = ui.precipCanvas.getContext('2d');
    let w, h, stars=[], particles=[];

    function resize() { 
        w=window.innerWidth; h=window.innerHeight; 
        ui.starCanvas.width=ui.precipCanvas.width=w; 
        ui.starCanvas.height=ui.precipCanvas.height=h; 
        if(stars.length === 0) initStars(); 
    }
    window.addEventListener('resize', resize);

    function initStars() { stars=[]; for(let i=0; i<150; i++) stars.push({x:Math.random()*w, y:Math.random()*h, s:Math.random()*1.5, a:Math.random()}); }
    
    function loop() {
        canvasS.clearRect(0,0,w,h); canvasP.clearRect(0,0,w,h);
        
        // Stars
        if(ui.starCanvas.style.opacity === '1') {
            canvasS.fillStyle="#fff";
            stars.forEach(s=>{ canvasS.globalAlpha=s.a; canvasS.beginPath(); canvasS.arc(s.x,s.y,s.s,0,Math.PI*2); canvasS.fill(); if(Math.random()>0.99) s.a=Math.random(); });
        }
        
        // Lightning Bolts (Storm Engine)
        if (STATE.lightningBolts.length > 0) {
            STATE.lightningBolts.forEach((bolt, index) => {
                canvasP.strokeStyle = `rgba(255, 255, 255, ${bolt.opacity})`;
                canvasP.lineWidth = 2;
                canvasP.shadowBlur = 20;
                canvasP.shadowColor = "#a855f7"; // Purple glow
                canvasP.beginPath();
                canvasP.moveTo(bolt.segments[0].x, bolt.segments[0].y);
                for (let i = 1; i < bolt.segments.length; i++) {
                    canvasP.lineTo(bolt.segments[i].x, bolt.segments[i].y);
                }
                canvasP.stroke();
                canvasP.shadowBlur = 0; // Reset
                
                bolt.opacity -= 0.05; // Fade out
                if (bolt.opacity <= 0) STATE.lightningBolts.splice(index, 1);
            });
        }

        // Precipitation
        particles.forEach(p => {
            p.y += p.vy; 
            p.x += p.vx || 0; // Add wind drift
            if(p.type==='snow') p.x+=Math.sin(p.y*0.01);
            
            if(p.y>h) { p.y=-10; p.x=Math.random()*w; }
            if(p.x>w) { p.x=0; }
            if(p.x<0) { p.x=w; }

            canvasP.beginPath();
            if(p.type==='rain') { 
                canvasP.strokeStyle='rgba(200,230,255,0.4)'; 
                canvasP.lineWidth=1; 
                canvasP.moveTo(p.x,p.y); 
                // Slant rain based on wind
                canvasP.lineTo(p.x - (p.vx || 0)*2, p.y+p.len); 
                canvasP.stroke(); 
            } 
            else { canvasP.fillStyle='rgba(255,255,255,0.8)'; canvasP.arc(p.x,p.y,p.s,0,Math.PI*2); canvasP.fill(); }
        });
        STATE.animationId = requestAnimationFrame(loop);
    }
    document.addEventListener("visibilitychange", () => { if (document.hidden) { if (STATE.animationId) cancelAnimationFrame(STATE.animationId); } else { loop(); } });
    resize(); loop();

    const weatherMeta = {
        0: { type: 'clear', day:['#0ea5e9','#93c5fd'], night:['#020617','#1e1b4b'] },
        1: { type: 'clear', day:['#38bdf8','#bae6fd'], night:['#0f172a','#172554'] },
        2: { type: 'cloudy', day:['#475569','#94a3b8'], night:['#1e293b','#334155'] },
        3: { type: 'overcast', day:['#334155','#64748b'], night:['#0f172a','#1e293b'] },
        45: { type: 'fog', day:['#6b7280','#9ca3af'], night:['#1f2937','#374151'] }, 48: { type: 'fog', day:['#6b7280','#9ca3af'], night:['#1f2937','#374151'] },
        51: { type: 'rain', day:['#2563eb','#60a5fa'], night:['#172554','#1e40af'] }, 53: { type: 'rain', day:['#2563eb','#60a5fa'], night:['#172554','#1e40af'] },
        55: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] }, 56: { type: 'rain', day:['#2563eb','#60a5fa'], night:['#172554','#1e40af'] },
        61: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] }, 63: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] },
        71: { type: 'snow', day:['#bae6fd','#e0f2fe'], night:['#1e293b','#334155'] }, 73: { type: 'snow', day:['#bae6fd','#e0f2fe'], night:['#1e293b','#334155'] },
        80: { type: 'rain', day:['#2563eb','#60a5fa'], night:['#172554','#1e40af'] }, 81: { type: 'rain', day:['#1d4ed8','#3b82f6'], night:['#172554','#1e3a8a'] },
        95: { type: 'storm', day:['#4c1d95','#6d28d9'], night:['#2e1065','#581c87'] }, 96: { type: 'storm', day:['#4c1d95','#6d28d9'], night:['#2e1065','#581c87'] }
    };

    function setAtmosphere(code, isDay) {
        // Stop lightning loop if not storm
        if (STATE.lightningTimer) clearTimeout(STATE.lightningTimer);
        
        const meta = weatherMeta[code] || weatherMeta[0];
        const type = meta.type;
        const c = isDay ? meta.day : meta.night;
        ui.sky.style.background = `linear-gradient(to bottom, ${c[0]}, ${c[1]})`;
        
        // Update Favicon based on weather
        let iconName = 'sunny';
        if(type === 'cloudy') iconName = 'partly_cloudy_day';
        if(type === 'overcast') iconName = 'cloud';
        if(type === 'rain') iconName = 'rainy';
        if(type === 'snow') iconName = 'weather_snowy';
        if(type === 'storm') iconName = 'thunderstorm';
        if(!isDay && type === 'clear') iconName = 'clear_night';
        ui.favicon.href = `https://fonts.gstatic.com/s/i/short-term/release/materialsymbolsrounded/${iconName}/default/24px.svg`;

        ui.aurora.innerHTML = '';
        let color = isDay ? (type==='storm'?'bg-purple-500':'bg-cyan-400') : (type==='storm'?'bg-purple-900':'bg-blue-900');
        ui.aurora.innerHTML = `<div class="aurora-blob ${color} w-[600px] h-[600px] top-[-20%] left-[-10%]"></div>`;

        updateCelestial(isDay);
        ui.celestial.style.opacity = (type==='overcast'||type==='storm'||type==='fog') ? '0.2' : '1';
        ui.starCanvas.style.opacity = (!isDay && type==='clear') ? '1' : '0';
        ui.mist.style.opacity = type==='fog' ? '1' : '0';
        ui.cloudsBack.style.opacity = (type==='cloudy'||type==='overcast'||type==='storm') ? '0.6' : '0';
        ui.cloudsFront.style.opacity = (type==='overcast'||type==='storm') ? '0.8' : '0';

        ui.cloudsBack.innerHTML = ''; ui.cloudsFront.innerHTML = '';
        if(type.includes('cloud') || type==='overcast' || type==='storm') {
            const count = type==='cloudy'?5:12;
            for(let i=0; i<count; i++) {
                const cl = document.createElement('div'); cl.className = 'cloud';
                const s = Math.random()*300+150; cl.style.width=s+'px'; cl.style.height=s+'px';
                cl.style.top=Math.random()*60+'%'; cl.style.left=Math.random()*100+'vw';
                cl.style.animationDuration = (Math.random()*60+60)+'s';
                if(i%2===0) ui.cloudsBack.appendChild(cl); else ui.cloudsFront.appendChild(cl);
            }
        }
        particles = [];
        if(type==='rain'||type==='storm') {
            // More particles for storm, faster speed
            const count = type==='storm' ? 800 : 400;
            const speedBase = type==='storm' ? 25 : 15;
            // Wind effect
            const wind = type==='storm' ? 5 : 0;
            
            for(let i=0;i<count;i++) {
                particles.push({
                    x:Math.random()*w,
                    y:Math.random()*h,
                    vy:Math.random()*15+speedBase,
                    vx: wind, // Horizontal movement
                    len:20,
                    type:'rain'
                });
            }
        }
        if(type==='snow') for(let i=0;i<200;i++) particles.push({x:Math.random()*w,y:Math.random()*h,vy:Math.random()*2+1,s:Math.random()*3+1,type:'snow'});
        
        if(type==='storm') triggerLightning();
    }

    function triggerLightning() {
        // 1. Sheet Lightning (Flash)
        const f = document.createElement('div'); 
        f.className = 'flash-anim'; 
        
        // Randomize flash position/style for sheet lightning feel
        const x = Math.random() * 100;
        const y = Math.random() * 50; // Upper half of screen
        f.style.background = `radial-gradient(circle at ${x}% ${y}%, rgba(255, 255, 255, 0.8) 0%, transparent 60%)`;
        
        ui.lightning.appendChild(f);
        setTimeout(()=>f.remove(), 300); 

        // 2. Bolt Generation (Canvas)
        if(Math.random() > 0.4) { // 60% chance of visible bolt
            const startX = Math.random() * w;
            const segments = [{x: startX, y: -50}];
            let currentX = startX;
            let currentY = -50;
            
            while (currentY < h * 0.8) {
                currentX += (Math.random() - 0.5) * 50; // Jitter X
                currentY += Math.random() * 30 + 10; // Move Down
                segments.push({x: currentX, y: currentY});
            }
            
            STATE.lightningBolts.push({ segments: segments, opacity: 1 });
        }

        // Loop with random delay
        STATE.lightningTimer = setTimeout(triggerLightning, Math.random()*2000 + 500);
    }

    // --- LOGIC ---
    function toggleSkeleton(loading) {
        document.body.classList.toggle('loaded', !loading);
    }

    async function fetchWeather(lat, lon, name) {
        toggleSkeleton(true);
        try {
            const [w, a] = await Promise.all([
                fetch(`${CONFIG.weather}?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,weather_code,wind_speed_10m,wind_direction_10m,wind_gusts_10m,surface_pressure,visibility,uv_index,dew_point_2m&hourly=temperature_2m,weather_code,precipitation_probability&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,precipitation_probability_max&timezone=auto&forecast_days=8`).then(r=>r.json()),
                fetch(`${CONFIG.aqi}?latitude=${lat}&longitude=${lon}&current=us_aqi,pm2_5,nitrogen_dioxide,ozone`).then(r=>r.json())
            ]);
            STATE.data = { ...w, aqi: a.current, cityName: name, lat, lon }; // Saved lat/lon for refresh
            // Simulate minimal network delay for skeleton effect demonstration
            setTimeout(() => { renderUI(); toggleSkeleton(false); }, 600);
        } catch(e) { console.error(e); ui.city.textContent = "Error"; }
    }

    function renderUI() {
        const d = STATE.data;
        const cur = d.current;
        const isDay = cur.is_day === 1;
        
        // Moon Phase (Always update widget)
        const phase = getMoonPhase(new Date());
        updateMoonWidget(phase);

        setAtmosphere(cur.weather_code, isDay);
        
        // Main Icon update
        const meta = weatherMeta[cur.weather_code] || weatherMeta[0];
        ui.desc.textContent = meta.type.toUpperCase();
        ui.bgIcon.textContent = meta.type==='clear'?(isDay?'sunny':'clear_night'):meta.type==='cloudy'?'partly_cloudy_day':meta.type==='overcast'?'cloud':meta.type==='rain'?'rainy':meta.type==='snow'?'weather_snowy':'thunderstorm';

        // Main
        ui.city.textContent = d.cityName;

        // Temps
        let t=cur.temperature_2m, fl=cur.apparent_temperature, mx=d.daily.temperature_2m_max[0], mn=d.daily.temperature_2m_min[0];
        if(!STATE.metric) { const f=c=>c*1.8+32; t=f(t); fl=f(fl); mx=f(mx); mn=f(mn); }
        ui.temp.textContent = Math.round(t); ui.feels.textContent = Math.round(fl)+'°';
        ui.tempMax.textContent = Math.round(mx)+'°'; ui.tempMin.textContent = Math.round(mn)+'°';
        document.title = `${d.cityName} • ${Math.round(t)}° | Aether`;

        // Clock
        if(STATE.timer) clearInterval(STATE.timer);
        const tick = () => {
            const now = new Date();
            ui.time.textContent = now.toLocaleTimeString('en-US',{timeZone:d.timezone,hour:'2-digit',minute:'2-digit',hour12:false});
            ui.date.textContent = now.toLocaleDateString('en-US',{timeZone:d.timezone,weekday:'short',month:'short',day:'numeric'});
            updateSolarTracker(d.daily.sunrise[0], d.daily.sunset[0], d.timezone);
        }; tick(); STATE.timer = setInterval(tick,1000);

        // GEAR ADVISOR LOGIC
        let gear = "Standard kit. Conditions normal.";
        const c = cur.weather_code;
        if(c >= 95) gear = "Hazard suit. Stay indoors.";
        else if(c >= 71) gear = "Thermal layers & heavy coat required.";
        else if(c >= 51 || cur.precipitation > 0) gear = "Waterproof shell & umbrella advised.";
        else if(cur.wind_speed_10m > 30) gear = "Windbreaker recommended.";
        else if(t < (STATE.metric?5:41)) gear = "Warm coat & gloves needed.";
        else if(t > (STATE.metric?25:77)) gear = "Breathable fabrics & sunglasses.";
        else if(cur.uv_index > 6) gear = "Sun protection required.";
        ui.gearMsg.textContent = gear;

        // Assistant Risk
        let tags = [], risk = 0;
        if(cur.weather_code>=95) { tags.push("STORM"); risk=2; }
        if(cur.precipitation>0) { tags.push("RAIN"); risk=1; }
        if(cur.uv_index>6) { tags.push("HIGH UV"); risk=1; }
        if(t < (STATE.metric?5:41)) { tags.push("FREEZING"); risk=1; }
        
        ui.aiTitle.textContent = risk===2?"Hazardous":risk===1?"Caution":"Optimal";
        ui.aiText.textContent = risk===2?"Severe weather. Seek shelter." : risk===1?"Atmosphere unstable. Prepare accordingly." : "Conditions are stable. Proceed with operations.";
        ui.aiIcon.textContent = risk===2?"warning":risk===1?"info":"check_circle";
        ui.aiTags.innerHTML = tags.map(t=>`<span class="px-2 py-0.5 rounded bg-cyan-500/20 text-[10px] font-bold text-cyan-200 border border-cyan-500/30">${t}</span>`).join('');

        // Metrics
        ui.windVal.textContent = Math.round(cur.wind_speed_10m);
        ui.windGusts.textContent = `Gusts: ${Math.round(cur.wind_gusts_10m)}`;
        ui.windIcon.style.transform = `rotate(${cur.wind_direction_10m}deg)`;
        const dirs = ['N','NE','E','SE','S','SW','W','NW'];
        ui.windDir.textContent = dirs[Math.round(cur.wind_direction_10m/45)%8] || 'N';
        
        ui.humidVal.textContent = cur.relative_humidity_2m;
        ui.visVal.textContent = (cur.visibility/1000).toFixed(1);
        ui.presVal.textContent = Math.round(cur.surface_pressure);
        ui.uvVal.textContent = cur.uv_index.toFixed(1);
        ui.uvBar.style.width = Math.min((cur.uv_index/11)*100,100)+'%';
        
        ui.aqiBadge.textContent = d.aqi.us_aqi<=50?'Good':d.aqi.us_aqi<=100?'Moderate':'Poor';
        ui.aqiBadge.className = `text-xs font-bold px-2 py-1 rounded bg-${d.aqi.us_aqi<=50?'green':d.aqi.us_aqi<=100?'yellow':'red'}-500/20 text-${d.aqi.us_aqi<=50?'green':d.aqi.us_aqi<=100?'yellow':'red'}-400`;
        ui.pm25.textContent = d.aqi.pm2_5; ui.no2.textContent = d.aqi.nitrogen_dioxide; ui.o3.textContent = d.aqi.ozone;

        // Activity Logic
        const setActivity = (id, score, text, colorClass) => {
            ui[id].textContent = text;
            ui[id].className = `text-sm font-bold ${colorClass}`;
        };

        // Running (Ideal: 10-20C, No Rain, Low Wind)
        let runScore = "Good"; let runColor = "text-green-400";
        if(cur.precipitation > 0 || cur.wind_speed_10m > 30 || cur.temperature_2m > 30 || cur.temperature_2m < 5) { runScore = "Poor"; runColor = "text-red-400"; }
        else if(cur.temperature_2m >= 10 && cur.temperature_2m <= 22) { runScore = "Ideal"; runColor = "text-cyan-400"; }
        setActivity('actRun', runScore, runScore, runColor);

        // Driving (Vis < 2000m, Rain/Snow codes)
        let driveScore = "Good"; let driveColor = "text-green-400";
        if(cur.visibility < 2000 || cur.weather_code >= 71) { driveScore = "Hazardous"; driveColor = "text-red-400"; }
        else if(cur.precipitation > 2 || cur.weather_code >= 51) { driveScore = "Caution"; driveColor = "text-yellow-400"; }
        setActivity('actDrive', driveScore, driveScore, driveColor);

        // Outdoor (UV, AQI, Rain)
        let outScore = "Great"; let outColor = "text-green-400";
        if(d.aqi.us_aqi > 150 || cur.precipitation > 0 || cur.uv_index >= 8) { outScore = "Limit"; outColor = "text-red-400"; }
        else if(d.aqi.us_aqi > 100 || cur.uv_index >= 6) { outScore = "Moderate"; outColor = "text-yellow-400"; }
        setActivity('actOut', outScore, outScore, outColor);

        // Health (AQI, Extreme Temps)
        let healthScore = "Good"; let healthColor = "text-green-400";
        if(d.aqi.us_aqi > 150 || cur.temperature_2m > 35 || cur.temperature_2m < -10) { healthScore = "Risk"; healthColor = "text-red-400"; }
        else if(d.aqi.us_aqi > 100) { healthScore = "Fair"; healthColor = "text-yellow-400"; }
        setActivity('actHealth', healthScore, healthScore, healthColor);

        // Forecast List
        ui.forecast.innerHTML = '';
        for(let i=1; i<8; i++) {
            const code = d.daily.weather_code[i];
            const m = weatherMeta[code] || weatherMeta[0];
            let mx = d.daily.temperature_2m_max[i], mn = d.daily.temperature_2m_min[i];
            if(!STATE.metric) { mx=mx*1.8+32; mn=mn*1.8+32; }
            const day = new Date(d.daily.time[i]).toLocaleDateString('en-US',{weekday:'short'});
            const pop = d.daily.precipitation_probability_max[i];
            
            const row = document.createElement('div');
            row.className = "flex items-center justify-between p-3 rounded-xl bg-white/5 hover:bg-white/10 transition-colors border border-white/5";
            row.innerHTML = `<div class="w-12"><div class="font-bold text-gray-300 text-sm">${day}</div>${pop>20?`<div class="text-[9px] text-blue-400 font-bold">${pop}%</div>`:''}</div>
            <span class="material-symbols-rounded text-cyan-400 text-xl">${m.type==='clear'?'sunny':m.type==='rain'?'rainy':m.type==='cloudy'?'partly_cloudy_day':'cloud'}</span>
            <div class="text-sm font-mono font-bold text-right"><span class="text-white">${Math.round(mx)}°</span> <span class="text-gray-500">/ ${Math.round(mn)}°</span></div>`;
            ui.forecast.appendChild(row);
        }

        renderChart(d.hourly);
        ui.radar.src = `https://embed.windy.com/embed.html?lat=${d.latitude}&lon=${d.longitude}&zoom=7&overlay=rain&menu=&metricWind=${STATE.metric?'kmh':'kt'}&metricTemp=${STATE.metric?'°C':'°F'}&isolines=false`;
        renderFavs();
    }

    // SOLAR TRACKER LOGIC
    function updateSolarTracker(sunriseStr, sunsetStr, timezone) {
        // Convert API ISO strings to Date objects relative to current day
        const now = new Date();
        const sunrise = new Date(sunriseStr);
        const sunset = new Date(sunsetStr);
        
        // Ensure accurate dates for calculation
        const nowTime = now.getTime();
        const riseTime = sunrise.getTime();
        const setTime = sunset.getTime();
        
        ui.sunrise.textContent = sunrise.toLocaleTimeString('en-US',{timeZone:timezone,hour:'2-digit',minute:'2-digit',hour12:false});
        ui.sunset.textContent = sunset.toLocaleTimeString('en-US',{timeZone:timezone,hour:'2-digit',minute:'2-digit',hour12:false});

        let pct = 0; // 0 = left (rise), 1 = right (set)
        const isDay = nowTime >= riseTime && nowTime <= setTime;
        
        if (isDay) {
            // Day: Move Sun
            pct = (nowTime - riseTime) / (setTime - riseTime);
            ui.markerSun.classList.remove('opacity-0');
            ui.markerMoon.classList.add('opacity-0');
        } else {
            // Night: Move Moon (Inverse logic for visual loop)
            // If before sunrise, it's late night. If after sunset, early night.
            ui.markerSun.classList.add('opacity-0');
            ui.markerMoon.classList.remove('opacity-0');
            
            // Simplified night tracking for visual loop (not astronomically perfect but visually consistent)
            // Maps night duration to 0-1 range
            const prevSunset = setTime - 86400000; 
            const nextSunrise = riseTime + 86400000; 
            
            if(nowTime > setTime) {
                // Evening until midnight
                 pct = (nowTime - setTime) / (nextSunrise - setTime); // 0 to 0.5 roughly
            } else {
                // Midnight until sunrise
                 pct = (nowTime - (riseTime - 43200000)) / 43200000; // rough estimation
            }
        }

        // Clamp 0-1
        pct = Math.max(0, Math.min(1, pct));
        
        // Map 0-1 to X/Y coordinates on a 200x100 SVG
        // Path: M 10 90 A 90 90 0 0 1 190 90
        // Center is (100, 90), Radius 90.
        // Angle goes from 180 (PI) at rise to 360/0 (0) at set? 
        // Arc command uses clockwise.
        // Let's use simple trigonometry for placement
        // Angle: Start at PI (180 deg, left), End at 0 (0 deg, right).
        // Actually for the arc A 90 90, we want to traverse from 180 degrees to 0 degrees (counter-clockwise visual, but SVG coord system y is down)
        // Correct angle: Rise = 180 deg, Set = 0 deg.
        
        const angle = Math.PI - (pct * Math.PI); // PI -> 0
        const r = 90;
        const cx = 100;
        const cy = 90;
        
        const x = cx + r * Math.cos(angle);
        const y = cy - r * Math.sin(angle);
        
        ui.solarMarker.style.transform = `translate(${x}px, ${y}px)`;
    }

    function renderChart(hourly) {
        if(STATE.chart) STATE.chart.destroy();
        const ctx = ui.chartCanvas.getContext('2d');
        const now = new Date().getHours();
        const labels=[], data=[], rain=[];
        let sumTemp = 0;
        for(let i=0; i<24; i++) {
            labels.push(`${(now+i)%24}:00`);
            let t = hourly.temperature_2m[now+i];
            if(!STATE.metric) t=t*1.8+32;
            data.push(t); sumTemp += t;
            rain.push(hourly.precipitation_probability[now+i]);
        }
        const avg = sumTemp / 24; const isHot = STATE.metric ? avg > 25 : avg > 77;
        const color = isHot ? '#f97316' : '#22d3ee';
        STATE.chart = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [
                { label:'Temp', data, borderColor: color, backgroundColor:(c)=>{const g=c.chart.ctx.createLinearGradient(0,0,0,200);g.addColorStop(0,isHot?'rgba(249,115,22,0.3)':'rgba(34,211,238,0.3)');g.addColorStop(1,'rgba(0,0,0,0)');return g;}, borderWidth:2, tension:0.4, fill:true, yAxisID:'y'},
                { label:'Rain %', data:rain, borderColor:'#3b82f6', borderDash:[5,5], borderWidth:1, pointRadius:0, fill:false, yAxisID:'y1' }
            ]},
            options: { 
                responsive:true, 
                maintainAspectRatio:false, 
                resizeDelay: 0,
                animation: false, 
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins:{
                    legend:{display:false},
                    tooltip: {
                        backgroundColor: 'rgba(10, 14, 24, 0.9)',
                        titleColor: '#fff',
                        bodyColor: '#cbd5e1',
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += Math.round(context.parsed.y);
                                    if(context.dataset.yAxisID === 'y') label += STATE.metric ? '°C' : '°F';
                                    else label += '%';
                                }
                                return label;
                            }
                        }
                    }
                }, 
                scales:{x:{display:false}, y:{display:false}, y1:{display:false, min:0, max:100}} 
            }
        });
    }

    // Interaction
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(t => {
        t.onclick = () => {
            tabs.forEach(b => b.classList.remove('active')); t.classList.add('active');
            ['tab-overview','tab-health','tab-activity'].forEach(id => {
                const p = el(id);
                if(id === t.dataset.tab) { p.style.opacity='1'; p.style.pointerEvents='auto'; } else { p.style.opacity='0'; p.style.pointerEvents='none'; }
            });
        };
    });

    let debounce;
    ui.input.addEventListener('input', e => {
        const q = e.target.value;
        if(q.length > 0) ui.clearBtn.classList.remove('hidden'); else ui.clearBtn.classList.add('hidden');
        clearTimeout(debounce);
        debounce = setTimeout(async () => {
            if(q.length<3) { ui.suggestions.classList.add('hidden'); return; }
            const r = await fetch(`${CONFIG.geo}?name=${q}&count=5`).then(res=>res.json());
            ui.suggestions.innerHTML = '';
            if(r.results) {
                r.results.forEach(p => {
                    const d = document.createElement('div'); d.className = "px-5 py-3 hover:bg-cyan-500/20 cursor-pointer text-sm text-white border-b border-white/5 flex justify-between";
                    d.innerHTML = `<span>${p.name}</span><span class="text-xs text-gray-500 font-bold uppercase">${p.country}</span>`;
                    d.onclick = () => { fetchWeather(p.latitude, p.longitude, p.name); ui.input.value=''; ui.clearBtn.classList.add('hidden'); ui.suggestions.classList.add('hidden'); };
                    ui.suggestions.appendChild(d);
                }); ui.suggestions.classList.remove('hidden');
            }
        }, 300);
    });
    ui.input.addEventListener('keydown', e => { if(e.key === 'Enter' && ui.suggestions.children.length > 0) { ui.suggestions.children[0].click(); ui.input.blur(); } });
    ui.clearBtn.onclick = () => { ui.input.value = ''; ui.clearBtn.classList.add('hidden'); ui.suggestions.classList.add('hidden'); ui.input.focus(); };

    const setUnit = (m) => { 
        STATE.metric=m; 
        localStorage.setItem('aether_units', m); // Save preference
        ui.unitPill.style.transform=m?'translateX(0)':'translateX(100%)'; 
        ui.btnC.style.color=m?'#fff':'#6b7280'; 
        ui.btnF.style.color=!m?'#fff':'#6b7280'; 
        renderUI(); 
    };
    ui.btnC.onclick = () => setUnit(true); ui.btnF.onclick = () => setUnit(false);
    ui.gpsBtn.onclick = () => navigator.geolocation.getCurrentPosition(p => fetchWeather(p.coords.latitude, p.coords.longitude, "My Location"));
    
    // Manual Refresh
    ui.refreshBtn.onclick = () => {
        if(STATE.data && STATE.data.lat && STATE.data.lon) {
            fetchWeather(STATE.data.lat, STATE.data.lon, STATE.data.cityName);
        }
    };

    // Close menus on click outside
    document.addEventListener('click', e => { 
        if(!el('search-input').contains(e.target) && !ui.clearBtn.contains(e.target)) ui.suggestions.classList.add('hidden'); 
    });

    function renderFavs() {
        ui.favBar.innerHTML = ''; ui.favBar.classList.remove('opacity-0');
        const isFav = STATE.favorites.includes(STATE.data.cityName);
        ui.favBtn.style.color = isFav ? '#ec4899' : 'rgba(255,255,255,0.4)';
        STATE.favorites.forEach(c => {
            const b = document.createElement('button');
            b.className = "px-4 py-2 rounded-xl bg-white/5 border border-white/10 text-xs font-bold text-gray-300 hover:text-white hover:bg-cyan-500/20 transition-all shadow-lg";
            b.textContent = c;
            b.onclick = async () => { const r = await fetch(`${CONFIG.geo}?name=${c}&count=1`).then(res=>res.json()); if(r.results) fetchWeather(r.results[0].latitude, r.results[0].longitude, r.results[0].name); };
            ui.favBar.appendChild(b);
        });
    }
    ui.favBtn.onclick = () => {
        const n = STATE.data.cityName;
        if(STATE.favorites.includes(n)) STATE.favorites = STATE.favorites.filter(c=>c!==n); else STATE.favorites.push(n);
        localStorage.setItem('aether_favs_v12', JSON.stringify(STATE.favorites)); renderFavs();
    };

    // --- STARTUP LOGIC ---
    function initApp() {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (p) => fetchWeather(p.coords.latitude, p.coords.longitude, "My Location"),
                (e) => {
                    console.log("GPS Denied, using random.");
                    loadRandomCity();
                }
            );
        } else {
            loadRandomCity();
        }
    }

    function loadRandomCity() {
        const c = RANDOM_CITIES[Math.floor(Math.random() * RANDOM_CITIES.length)];
        fetchWeather(c.lat, c.lon, c.name);
    }

    // Start
    initApp();
    
    document.addEventListener('click', e => { if(!el('search-input').contains(e.target) && !ui.clearBtn.contains(e.target)) ui.suggestions.classList.add('hidden'); });
});
</script>
</body>
</html>
